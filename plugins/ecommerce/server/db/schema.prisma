generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "sqlite"
  url      = "file:./ecommerce.db"
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

model Order {
  id         String       @id @default(cuid())
  studentId  String
  student    StudentMirror @relation(fields: [studentId], references: [id])
  email      String?
  currency   String       @default("EUR")
  subtotal   Float        @default(0)
  discount   Float        @default(0)
  total      Float        @default(0)
  status     OrderStatus  @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  items      OrderItem[]
  payments   Payment[]

  @@index([studentId])
}

model StudentMirror {
  id          String   @id
  userId      String?
  displayName String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      Order[]

  @@index([userId])
}

model OrderItem {
  id             String  @id @default(cuid())
  orderId        String
  order          Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  courseId       String
  titleSnapshot  String
  priceSnapshot  Float
  quantity       Int     @default(1)

  @@index([courseId])
}

model Payment {
  id         String        @id @default(cuid())
  orderId    String
  order      Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider   String?
  status     PaymentStatus @default(PENDING)
  amount     Float
  payload    Json?
  createdAt  DateTime      @default(now())
}
