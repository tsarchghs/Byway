import{g as xe,W as Ue,r as o,l as V,k as Oe,c as G,a as s,b as t,t as p,w as l,aj as De,n as _,p as u,o as w,d as m,x as N,aA as Ne,S as Be,ab as Ee,G as Y,L as Te,q,I as Z,J as ee,_ as Le}from"./DQDUwbr-.js";import{u as Me}from"./CI-SnmTa.js";const Fe={class:"inst-page"},Re={class:"page-header"},he={class:"title"},qe={class:"subtitle"},je={class:"actions"},Je={class:"stat-value"},Pe={class:"stat-value"},ze={class:"stat-value"},Ve={class:"stat-value"},Ge={class:"card-head"},He={class:"card-title"},We={class:"card-sub"},Ke={class:"row"},Qe={class:"row"},Xe={class:"row"},Ye={class:"card-actions"},Ze=xe({__name:"[id]",setup(et){const te=De(),ae=Ue().public?.apiBase||"http://localhost:4000",{token:le}=Me(),g=o(null),A=o([]),x=o([]),H=o([]),ne=o([]),b=o(!1),U=o(""),B=o(!1),E=o(!1),T=o(!1),L=o(!1),I=o(null),r=o({}),$=o({}),v=o({}),S=o({role:"student",expiresAt:null}),C=o(void 0),M=o([]),se=o([]),oe=o([]);function ie(){const n=le?.value||(typeof window<"u"?localStorage.getItem("token"):"");return n?{Authorization:`Bearer ${n}`}:{}}async function k(n,e={}){const c=await(await fetch(`${ae}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",...ie()},body:JSON.stringify({query:n,variables:e})})).json();if(c.errors?.length)throw new Error(c.errors[0].message);return c.data}async function O(){b.value=!0;try{const n=String(te.params.id),e=await k(`
      query($id:String!){
        institution(id:$id){ id name slug type location email phone active }
        departments(institutionId:$id){ id name slug active }
        classrooms(institutionId:$id){ id title code departmentId capacity status courseIds enrollments { id } }
        members(institutionId:$id){ id userId role status }
        stats(institutionId:$id){ classrooms activeClassrooms departments members students }
      }
    `,{id:n});g.value=e?.institution||null,A.value=e?.departments||[],x.value=(e?.classrooms||[]).map(d=>({...d,enrollment:d.enrollments?.length||0})),H.value=e?.members||[]}catch(n){_.error(n?.message||"Unable to load institution")}finally{b.value=!1}}const W=V(()=>x.value.filter(n=>{const e=I.value?n.departmentId===I.value.id:!0,d=U.value?(n.title||"").toLowerCase().includes(U.value.toLowerCase())||(n.code||"").toLowerCase().includes(U.value.toLowerCase()):!0;return e&&d})),K=V(()=>{const n=x.value.length,e=x.value.filter(d=>d.status==="active").length;return{total:n,active:e}}),ue=V(()=>x.value.reduce((n,e)=>n+(e.enrollment||0),0));function de(n){return n&&A.value.find(e=>e.id===n)?.name||"—"}function re(n){I.value=I.value?.id===n.id?null:n}function ve(){r.value={...g.value},B.value=!0}function ce(n){$.value=n?{...n}:{name:"",slug:"",active:!0},E.value=!0}function Q(n){v.value=n?{...n}:{title:"",code:"",departmentId:I.value?.id,capacity:30,status:"active"},T.value=!0,loadCourseOptions();try{const e=v.value?.courseIds;if(e){const d=JSON.parse(e);C.value=d?.courseId||void 0,M.value=Array.isArray(d?.preferredModuleIds)?d.preferredModuleIds:[],C.value&&loadModuleOptions(String(C.value))}}catch{}}function pe(){S.value={role:"student",expiresAt:null},L.value=!0}async function me(){try{await k(`mutation($id:String!,$name:String,$slug:String,$type:String,$location:String,$email:String,$phone:String,$active:Boolean){
        updateInstitution(id:$id,name:$name,slug:$slug,type:$type,location:$location,email:$email,phone:$phone,active:$active){ id }
      }`,{...r.value,id:g.value.id}),B.value=!1,await O(),_.success("Institution updated")}catch(n){_.error(n?.message||"Update failed")}}async function fe(){try{const n={institutionId:g.value.id,...$.value},e=$.value.id?"mutation($id:String!,$name:String,$slug:String,$contact:String,$head:String,$active:Boolean){ updateDepartment(id:$id,name:$name,slug:$slug,contact:$contact,head:$head,active:$active){ id } }":"mutation($institutionId:String!,$name:String!,$slug:String!,$contact:String,$head:String,$active:Boolean){ createDepartment(institutionId:$institutionId,name:$name,slug:$slug,contact:$contact,head:$head,active:$active){ id } }";await k(e,n),E.value=!1,await O(),_.success("Department saved")}catch(n){_.error(n?.message||"Save failed")}}async function ge(){try{const n={institutionId:g.value.id,...v.value},e=v.value.id?`mutation($id:String!,$departmentId:String,$name:String,$code:String,$teacherId:String,$capacity:Int,$status:String,$startsAt:String,$endsAt:String,$courseIds:String){
          updateClassroom(id:$id,departmentId:$departmentId,name:$name,code:$code,teacherId:$teacherId,capacity:$capacity,status:$status,startsAt:$startsAt,endsAt:$endsAt,courseIds:$courseIds){ id }
        }`:`mutation($institutionId:String!,$departmentId:String,$name:String!,$code:String!,$teacherId:String,$capacity:Int,$status:String,$startsAt:String,$endsAt:String,$courseIds:String){
          createClassroom(institutionId:$institutionId,departmentId:$departmentId,name:$name,code:$code,teacherId:$teacherId,capacity:$capacity,status:$status,startsAt:$startsAt,endsAt:$endsAt,courseIds:$courseIds){ id }
        }`;n.name=n.title||n.name,C.value&&(n.courseIds=JSON.stringify({courseId:C.value,preferredModuleIds:M.value})),await k(e,n),T.value=!1,await O(),_.success("Classroom saved")}catch(n){_.error(n?.message||"Save failed")}}async function $e(){try{const n={institutionId:g.value.id,role:S.value.role};S.value.expiresAt&&(n.expiresAt=S.value.expiresAt),await k("mutation($institutionId:String!,$role:String!,$expiresAt:String){ createInvite(institutionId:$institutionId, role:$role, expiresAt:$expiresAt){ id code } }",n),L.value=!1,_.success("Invite created"),await _e()}catch(n){_.error(n?.message||"Invite failed")}}async function _e(){try{const n=await k("query($id:String!){ stats(institutionId:$id){ members } }",{id:g.value.id})}catch{}}function Ie(n){Q({...n,name:n.title})}function Se(){O()}return Oe(()=>{O()}),(n,e)=>{const d=u("a-button"),c=u("a-card"),y=u("a-col"),j=u("a-row"),J=u("a-list-item-meta"),P=u("a-list-item"),z=u("a-list"),ye=u("a-input-search"),be=u("a-empty"),Ce=u("a-tag"),f=u("a-input"),i=u("a-form-item"),X=u("a-switch"),F=u("a-form"),R=u("a-modal"),D=u("a-select-option"),h=u("a-select"),we=u("a-input-number"),ke=u("a-date-picker");return w(),G("div",Fe,[s("div",Re,[s("div",null,[s("div",he,p(g.value?.name||"Institution"),1),s("div",qe,p(g.value?.location||"No location set"),1)]),s("div",je,[t(d,{onClick:Se,loading:b.value},{default:l(()=>[t(N(Ne)),e[24]||(e[24]=m(" Refresh",-1))]),_:1},8,["loading"]),t(d,{type:"default",onClick:ve},{default:l(()=>[t(N(Be)),e[25]||(e[25]=m(" Settings",-1))]),_:1}),t(d,{type:"primary",onClick:pe},{default:l(()=>[t(N(Ee)),e[26]||(e[26]=m(" Invite",-1))]),_:1}),t(d,{type:"primary",onClick:ce},{default:l(()=>[t(N(Y)),e[27]||(e[27]=m(" Add Department",-1))]),_:1}),t(d,{type:"primary",onClick:Q},{default:l(()=>[t(N(Y)),e[28]||(e[28]=m(" New Classroom",-1))]),_:1})])]),t(j,{gutter:16,class:"section"},{default:l(()=>[t(y,{xs:12,md:6},{default:l(()=>[t(c,null,{default:l(()=>[e[29]||(e[29]=s("div",{class:"stat-label"},"Departments",-1)),s("div",Je,p(A.value.length),1)]),_:1})]),_:1}),t(y,{xs:12,md:6},{default:l(()=>[t(c,null,{default:l(()=>[e[30]||(e[30]=s("div",{class:"stat-label"},"Classrooms",-1)),s("div",Pe,p(K.value.total),1)]),_:1})]),_:1}),t(y,{xs:12,md:6},{default:l(()=>[t(c,null,{default:l(()=>[e[31]||(e[31]=s("div",{class:"stat-label"},"Active Classrooms",-1)),s("div",ze,p(K.value.active),1)]),_:1})]),_:1}),t(y,{xs:12,md:6},{default:l(()=>[t(c,null,{default:l(()=>[e[32]||(e[32]=s("div",{class:"stat-label"},"Total Enrollment",-1)),s("div",Ve,p(ue.value),1)]),_:1})]),_:1})]),_:1}),t(j,{gutter:16,class:"section"},{default:l(()=>[t(y,{xs:24,md:6},{default:l(()=>[t(c,{title:"Departments",loading:b.value},{default:l(()=>[t(z,{"data-source":A.value},{renderItem:l(({item:a})=>[t(P,{class:Te(["dept-item",I.value?.id===a.id?"active":""]),onClick:Ae=>re(a)},{default:l(()=>[t(J,{title:a.name,description:a.active?"Active":"Inactive"},null,8,["title","description"])]),_:2},1032,["class","onClick"])]),_:1},8,["data-source"])]),_:1},8,["loading"])]),_:1}),t(y,{xs:24,md:12},{default:l(()=>[t(c,{title:I.value?`${I.value.name} Classrooms`:"All Classrooms",loading:b.value},{default:l(()=>[t(ye,{value:U.value,"onUpdate:value":e[0]||(e[0]=a=>U.value=a),placeholder:"Search classrooms...",class:"mb-3"},null,8,["value"]),W.value.length===0?(w(),q(be,{key:0,description:"No classrooms"})):(w(),q(j,{key:1,gutter:12},{default:l(()=>[(w(!0),G(Z,null,ee(W.value,a=>(w(),q(y,{key:a.id,xs:24,sm:12},{default:l(()=>[t(c,{hoverable:""},{default:l(()=>[s("div",Ge,[s("div",null,[s("div",He,p(a.title||a.code),1),s("div",We,p(a.code),1)]),t(Ce,{color:a.status==="active"?"green":"default"},{default:l(()=>[m(p(a.status||"pending"),1)]),_:2},1032,["color"])]),s("div",Ke,[e[33]||(e[33]=s("span",null,"Capacity",-1)),s("strong",null,p(a.capacity||30),1)]),s("div",Qe,[e[34]||(e[34]=s("span",null,"Enrollment",-1)),s("strong",null,p(a.enrollment||0),1)]),s("div",Xe,[e[35]||(e[35]=s("span",null,"Department",-1)),s("strong",null,p(de(a.departmentId)),1)]),s("div",Ye,[t(d,{size:"small",onClick:Ae=>Ie(a)},{default:l(()=>[...e[36]||(e[36]=[m("Edit",-1)])]),_:1},8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1}))]),_:1},8,["title","loading"])]),_:1}),t(y,{xs:24,md:6},{default:l(()=>[t(c,{title:"Members",loading:b.value},{default:l(()=>[t(z,{"data-source":H.value},{renderItem:l(({item:a})=>[t(P,null,{default:l(()=>[t(J,{title:a.userId,description:a.role},null,8,["title","description"])]),_:2},1024)]),_:1},8,["data-source"])]),_:1},8,["loading"]),t(c,{title:"Invites",class:"mt-3",loading:b.value},{default:l(()=>[t(z,{"data-source":ne.value},{renderItem:l(({item:a})=>[t(P,null,{default:l(()=>[t(J,{title:a.code,description:`Role: ${a.role}`},null,8,["title","description"])]),_:2},1024)]),_:1},8,["data-source"])]),_:1},8,["loading"])]),_:1})]),_:1}),t(R,{open:B.value,"onUpdate:open":e[8]||(e[8]=a=>B.value=a),title:"Institution Settings","ok-text":"Save",onOk:me},{default:l(()=>[t(F,{layout:"vertical"},{default:l(()=>[t(i,{label:"Name"},{default:l(()=>[t(f,{value:r.value.name,"onUpdate:value":e[1]||(e[1]=a=>r.value.name=a)},null,8,["value"])]),_:1}),t(i,{label:"Slug"},{default:l(()=>[t(f,{value:r.value.slug,"onUpdate:value":e[2]||(e[2]=a=>r.value.slug=a)},null,8,["value"])]),_:1}),t(i,{label:"Type"},{default:l(()=>[t(f,{value:r.value.type,"onUpdate:value":e[3]||(e[3]=a=>r.value.type=a)},null,8,["value"])]),_:1}),t(i,{label:"Location"},{default:l(()=>[t(f,{value:r.value.location,"onUpdate:value":e[4]||(e[4]=a=>r.value.location=a)},null,8,["value"])]),_:1}),t(i,{label:"Email"},{default:l(()=>[t(f,{value:r.value.email,"onUpdate:value":e[5]||(e[5]=a=>r.value.email=a)},null,8,["value"])]),_:1}),t(i,{label:"Phone"},{default:l(()=>[t(f,{value:r.value.phone,"onUpdate:value":e[6]||(e[6]=a=>r.value.phone=a)},null,8,["value"])]),_:1}),t(i,{label:"Active"},{default:l(()=>[t(X,{checked:r.value.active,"onUpdate:checked":e[7]||(e[7]=a=>r.value.active=a)},null,8,["checked"])]),_:1})]),_:1})]),_:1},8,["open"]),t(R,{open:E.value,"onUpdate:open":e[12]||(e[12]=a=>E.value=a),title:"Department","ok-text":"Save",onOk:fe},{default:l(()=>[t(F,{layout:"vertical"},{default:l(()=>[t(i,{label:"Name"},{default:l(()=>[t(f,{value:$.value.name,"onUpdate:value":e[9]||(e[9]=a=>$.value.name=a)},null,8,["value"])]),_:1}),t(i,{label:"Slug"},{default:l(()=>[t(f,{value:$.value.slug,"onUpdate:value":e[10]||(e[10]=a=>$.value.slug=a)},null,8,["value"])]),_:1}),t(i,{label:"Active"},{default:l(()=>[t(X,{checked:$.value.active,"onUpdate:checked":e[11]||(e[11]=a=>$.value.active=a)},null,8,["checked"])]),_:1})]),_:1})]),_:1},8,["open"]),t(R,{open:T.value,"onUpdate:open":e[20]||(e[20]=a=>T.value=a),title:"Classroom","ok-text":"Save",onOk:ge},{default:l(()=>[t(F,{layout:"vertical"},{default:l(()=>[t(i,{label:"Title"},{default:l(()=>[t(f,{value:v.value.title,"onUpdate:value":e[13]||(e[13]=a=>v.value.title=a)},null,8,["value"])]),_:1}),t(i,{label:"Code"},{default:l(()=>[t(f,{value:v.value.code,"onUpdate:value":e[14]||(e[14]=a=>v.value.code=a)},null,8,["value"])]),_:1}),t(i,{label:"Department"},{default:l(()=>[t(h,{value:v.value.departmentId,"onUpdate:value":e[15]||(e[15]=a=>v.value.departmentId=a),"allow-clear":""},{default:l(()=>[t(D,{value:void 0},{default:l(()=>[...e[37]||(e[37]=[m("—",-1)])]),_:1}),(w(!0),G(Z,null,ee(A.value,a=>(w(),q(D,{key:a.id,value:a.id},{default:l(()=>[m(p(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),t(i,{label:"Capacity"},{default:l(()=>[t(we,{value:v.value.capacity,"onUpdate:value":e[16]||(e[16]=a=>v.value.capacity=a),min:1,max:500,style:{width:"100%"}},null,8,["value"])]),_:1}),t(i,{label:"Status"},{default:l(()=>[t(f,{value:v.value.status,"onUpdate:value":e[17]||(e[17]=a=>v.value.status=a),placeholder:"active/inactive"},null,8,["value"])]),_:1}),t(i,{label:"Teach course"},{default:l(()=>[t(h,{value:C.value,"onUpdate:value":e[18]||(e[18]=a=>C.value=a),options:se.value,"allow-clear":"",placeholder:"Select course"},null,8,["value","options"])]),_:1}),t(i,{label:"Preferred modules"},{default:l(()=>[t(h,{value:M.value,"onUpdate:value":e[19]||(e[19]=a=>M.value=a),options:oe.value,mode:"multiple","allow-clear":"",placeholder:"Select modules"},null,8,["value","options"])]),_:1})]),_:1})]),_:1},8,["open"]),t(R,{open:L.value,"onUpdate:open":e[23]||(e[23]=a=>L.value=a),title:"Create Invite","ok-text":"Create",onOk:$e},{default:l(()=>[t(F,{layout:"vertical"},{default:l(()=>[t(i,{label:"Role"},{default:l(()=>[t(h,{value:S.value.role,"onUpdate:value":e[21]||(e[21]=a=>S.value.role=a)},{default:l(()=>[t(D,{value:"student"},{default:l(()=>[...e[38]||(e[38]=[m("Student",-1)])]),_:1}),t(D,{value:"teacher"},{default:l(()=>[...e[39]||(e[39]=[m("Teacher",-1)])]),_:1}),t(D,{value:"admin"},{default:l(()=>[...e[40]||(e[40]=[m("Admin",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),t(i,{label:"Expires At (optional)"},{default:l(()=>[t(ke,{value:S.value.expiresAt,"onUpdate:value":e[22]||(e[22]=a=>S.value.expiresAt=a),style:{width:"100%"},"show-time":""},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["open"])])}}}),nt=Le(Ze,[["__scopeId","data-v-7c9ec049"]]);export{nt as default};
