import{g as V,U as Y,W as j,r as I,j as T,k as F,q as w,w as a,p as l,o as A,b as n,x as e,a as i,bu as E,d as O,t as v,m as S}from"./DQDUwbr-.js";const L={class:"mb-4 flex flex-wrap gap-2 items-center"},M={class:"grid md:grid-cols-4 gap-3 mb-4"},W={class:"text-2xl"},H={class:"text-2xl"},J={class:"text-2xl"},K={class:"text-2xl"},as=V({__name:"dashboard",setup(Q){const g=Y(),r=j().public?.apiBase||"http://localhost:4000",b=I(""),$=I([]),q=I([]),t=T({classrooms:0,assignments:0,submissions:0,enrollments:0}),P=[{title:"Classroom",dataIndex:"name",key:"name"},{title:"Assignments",dataIndex:"assignmentsCount",key:"assignmentsCount"},{title:"Submissions",dataIndex:"submissionsCount",key:"submissionsCount"},{title:"Enrollments",dataIndex:"enrollments",key:"enrollments"},{title:"Actions",key:"act",customRender:({record:d})=>S("div",{},[S("a",{href:`/institutions/${g.params.slug}/assignments/${d.latestAssignmentId}/grading`},"Grade latest"),S("span"," · "),S("a",{onClick:()=>exportGradebook(d.id)},"Export gradebook")])}],z=[{title:"Assignment",dataIndex:"assignmentId",key:"assignmentId"},{title:"Student",dataIndex:"studentId",key:"studentId"},{title:"File",dataIndex:"fileUrl",key:"fileUrl"},{title:"Grade",dataIndex:"grade",key:"grade"}];async function B(){$.value=[],q.value=[],t.classrooms=t.assignments=t.submissions=t.enrollments=0;const f=(await $fetch(`${r}/api/teach-internal/graphql`,{method:"POST",body:{query:"query($courseId:String,$institutionId:String){ classroomsByCourse(courseId:$courseId, institutionId:$institutionId){ id name } }",variables:{courseId:b.value||"ANY",institutionId:String(g.params.slug)}}}).catch(()=>null))?.data?.classroomsByCourse??[];for(const o of f){const c=(await $fetch(`${r}/api/teach-internal/graphql`,{method:"POST",body:{query:"query($classroomId:String!){ assignmentsByClassroom(classroomId:$classroomId){ id } }",variables:{classroomId:o.id}}}))?.data?.assignmentsByClassroom??[],_=c.length;let y=0,m=c[0]?.id||"";for(const x of c){const k=(await $fetch(`${r}/api/teach-internal/graphql`,{method:"POST",body:{query:"query($assignmentId:String!){ submissionsByAssignment(assignmentId:$assignmentId){ id studentId fileUrl grade } }",variables:{assignmentId:x.id}}}))?.data?.submissionsByAssignment??[];y+=k.length,k.length>0&&(q.value.push(...k.slice(0,3).map(G=>({...G,assignmentId:x.id}))),m=x.id)}const R=(await $fetch(`${r}/api/students-internal/graphql`,{method:"POST",body:{query:"query($classroomId:String!){ enrollmentCountByClassroom(classroomId:$classroomId) }",variables:{classroomId:o.id}}}))?.data?.enrollmentCountByClassroom??0;$.value.push({id:o.id,name:o.name,assignmentsCount:_,submissionsCount:y,enrollments:R,latestAssignmentId:m}),t.classrooms++,t.assignments+=_,t.submissions+=y,t.enrollments+=R}}F(async()=>{await N(),await B()});const h=T({primaryColor:"",bannerUrl:""});async function N(){const s=await $fetch(`${r}/api/authentication/graphql`,{method:"POST",body:{query:"query($slug:String!){ institutionBySlug(slug:$slug){ primaryColor bannerUrl } }",variables:{slug:String(g.params.slug)}}});h.primaryColor=s?.data?.institutionBySlug?.primaryColor||"",h.bannerUrl=s?.data?.institutionBySlug?.bannerUrl||""}const p=I(""),C=I(null);async function D(){if(!p.value){C.value=null;return}const s=await $fetch(`${r}/api/authentication/graphql`,{method:"POST",body:{query:"query($userId:String!,$institutionId:String!,$role:String!){ hasRole(userId:$userId,institutionId:$institutionId,role:$role) }",variables:{userId:p.value,institutionId:String(g.params.slug),role:"Admin"}}});C.value=!!s?.data?.hasRole}return(d,s)=>{const f=l("a-input"),o=l("a-button"),u=l("a-card"),U=l("a-alert"),c=l("a-table"),_=l("a-divider"),y=l("a-layout");return A(),w(y,{class:"p-6"},{default:a(()=>[n(u,{title:`Dashboard · ${e(g).params.slug}`,headStyle:e(h).primaryColor?{background:e(h).primaryColor,color:"#fff"}:{},bordered:!1},{default:a(()=>[i("div",L,[n(f,{value:e(p),"onUpdate:value":s[0]||(s[0]=m=>E(p)?p.value=m:null),placeholder:"Your userId (for roles)",style:{"max-width":"260px"}},null,8,["value"]),n(o,{onClick:D},{default:a(()=>[...s[2]||(s[2]=[O("Check Access",-1)])]),_:1}),n(f,{value:e(b),"onUpdate:value":s[1]||(s[1]=m=>E(b)?b.value=m:null),placeholder:"Course ID filter (optional)",style:{"max-width":"260px"}},null,8,["value"]),n(o,{onClick:B},{default:a(()=>[...s[3]||(s[3]=[O("Load",-1)])]),_:1})]),i("div",M,[n(u,{size:"small",title:"Classrooms"},{default:a(()=>[i("div",W,v(e(t).classrooms),1)]),_:1}),n(u,{size:"small",title:"Assignments"},{default:a(()=>[i("div",H,v(e(t).assignments),1)]),_:1}),n(u,{size:"small",title:"Submissions"},{default:a(()=>[i("div",J,v(e(t).submissions),1)]),_:1}),n(u,{size:"small",title:"Enrollments (total)"},{default:a(()=>[i("div",K,v(e(t).enrollments),1)]),_:1})]),e(C)===!1?(A(),w(U,{key:0,type:"warning",message:"Access denied: Admin role required","show-icon":"",class:"mb-3"})):(A(),w(c,{key:1,"data-source":e($),columns:P,"row-key":"id"},null,8,["data-source"])),n(_),s[4]||(s[4]=i("h3",null,"Recent Submissions",-1)),n(c,{"data-source":e(q),columns:z,"row-key":"id"},null,8,["data-source"])]),_:1},8,["title","headStyle"])]),_:1})}}});export{as as default};
