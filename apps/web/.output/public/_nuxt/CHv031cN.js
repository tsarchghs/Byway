import{g as Re,l as U,r as E,j as G,k as Ue,c as b,b as a,w as t,p as l,ak as Te,o as s,d as _,t as f,q as n,K as k,I as z,J as re,a as F,ag as Ne,m as i,F as $e,n as T,_ as qe}from"./DQDUwbr-.js";import{u as Be}from"./CI-SnmTa.js";const Me={class:"profile-page"},De={class:"course-meta"},Ge={class:"title"},ze={class:"muted"},Fe={class:"muted small"},Qe={key:1},je={key:2},ne="http://localhost:4000/api/authentication/graphql",ie="http://localhost:4000/api/students-internal/graphql",Ye="http://localhost:4000/api/courses-details/graphql",K="http://localhost:4000/api/ecommerce/graphql",Ke=`
  query Me {
    me { id email name createdAt avatar role }
  }
`,Ve=`
  query MyEnrollments {
    myEnrollments {
      id
      courseId
      createdAt
    }
  }
`,Je=`
  query Progress($courseId: String!) {
    progress(courseId: $courseId) {
      percent
      completedLessons
      totalLessons
    }
  }
`,We=`
  query One($id: String!) {
    course(id: $id) {
      id title category difficulty level thumb
    }
  }
`,ue=`
  query MyOrders {
    myOrders {
      id
      status
      total
      currency
      createdAt
      items { courseId title price quantity }
    }
  }
`,He=`
  mutation Portal($returnUrl:String!) {
    createBillingPortal(returnUrl:$returnUrl){
      url
    }
  }
`,Xe=`
  mutation UpdateProfile($input: UpdateProfileInput!) {
    updateProfile(input: $input) {
      id
      email
      name
      avatar
      role
    }
  }
`,Ze=Re({__name:"profile-page",setup(et){const S=Be(),de=Te(),x=U(()=>S.isLoggedIn.value),V=U(()=>S.token.value||""),J=U(()=>S.user.value?.email||""),W=E("overview"),d=G({profile:!1,courses:!1,orders:!1,portal:!1,save:!1}),P=E(null),A=E(null),c=G({}),N=E(null),$=E([]),C=E([]),H=U(()=>$.value.slice(0,5)),X=U(()=>C.value.slice(0,5)),g=G({enrolled:0,orders:0,wishlist:0,completedLessons:0}),y=G({name:"",title:"",bio:""});function Z(o,e="EUR"){return new Intl.NumberFormat("de-DE",{style:"currency",currency:e}).format(o||0)}function Q(o){try{return new Date(o).toLocaleString()}catch{return o}}function ee(o){const e=(o||"").toLowerCase();return e.includes("paid")||e.includes("succeeded")?"green":e.includes("pending")||e.includes("requires")?"gold":e.includes("failed")||e.includes("canceled")?"red":"blue"}function ce(){S.logout()}function te(o){de.push(`/course/${encodeURIComponent(o)}`)}async function w(o,e,m){const p={"Content-Type":"application/json"};V.value&&(p.Authorization=`Bearer ${V.value}`);const v=await(await fetch(o,{method:"POST",headers:p,body:JSON.stringify({query:e,variables:m})})).json();if(v.errors?.length)throw new Error(v.errors[0].message||"GraphQL error");return v.data}function pe(o){return i("div",{class:"row-wrap",onClick:()=>te(o.id)},[i("img",{class:"row-thumb",src:o.thumb||"/course-thumb.jpg",alt:o.title}),i("div",{class:"row-main"},[i("div",{class:"row-title"},o.title),i("div",{class:"muted"},`${o.category||"—"} · ${o.level||"All levels"}`),i("div",{class:"row-inline"},[i("span",{class:"muted small"},`Progress: ${o.progress?.percent??0}%`)])])])}function me(o){return i("div",{class:"row-wrap"},[i("div",{class:"row-icon"},[i($e)]),i("div",{class:"row-main"},[i("div",{class:"row-title"},`Order ${o.id.slice(0,8)}…`),i("div",{class:"muted small"},Q(o.createdAt)),i("div",{class:"row-inline"},[i("span",{class:"muted small"},(o.items||[]).map(e=>e.title||e.courseId).join(", ")||"—")])]),i("div",{class:"row-right"},[i("div",{class:"row-amount"},Z(o.total||0,o.currency||"EUR")),i("div",null,[i("span",null,[i("span",{class:`status-dot ${ee(o.status)}`})])])])])}const _e=[{title:"Order ID",dataIndex:"id",key:"id"},{title:"Created",dataIndex:"createdAt",key:"createdAt"},{title:"Items",dataIndex:"items",key:"items"},{title:"Status",dataIndex:"status",key:"status"},{title:"Total",dataIndex:"total",key:"total",align:"right"}];async function fe(){d.profile=!0;try{const e=(await w(ne,Ke))?.me;e?(c.name=e.name||"",c.avatar=e.avatar||"",c.role=e.role||"Student",N.value=e.createdAt?Q(e.createdAt):null,y.name=c.name||""):(c.name=S.user.value?.name||"",c.avatar="",c.role="Student",N.value=null)}catch{c.name=S.user.value?.name||"",c.avatar="",c.role="Student",N.value=null}finally{d.profile=!1}}async function ye(){d.courses=!0;const o=[];let e=[];try{e=((await w(ie,Ve))?.myEnrollments||[]).map(p=>({courseId:p.courseId}))}catch{try{const m=await w(K,ue),p=new Set;(m?.myOrders||[]).forEach(u=>(u.items||[]).forEach(v=>v.courseId&&p.add(v.courseId))),e=Array.from(p).map(u=>({courseId:u}))}catch{e=[]}}for(const m of e)try{const u=(await w(Ye,We,{id:m.courseId}))?.course;if(!u)continue;let v=null;try{v=(await w(ie,Je,{courseId:m.courseId}))?.progress||null}catch{v=null}o.push({id:u.id,title:u.title,category:u.category,level:u.level||u.difficulty,thumb:u.thumb,progress:v})}catch{}$.value=o,g.enrolled=o.length,g.completedLessons=o.reduce((m,p)=>m+(p.progress?.completedLessons||0),0),d.courses=!1}async function ve(){d.orders=!0;try{const o=await w(K,ue);C.value=(o?.myOrders||[]).sort((e,m)=>new Date(m.createdAt).getTime()-new Date(e.createdAt).getTime()),g.orders=C.value.length}catch{C.value=[],g.orders=0}finally{d.orders=!1}}function ge(){try{const e=[];g.wishlist=Array.isArray(e)?e.length:0}catch{g.wishlist=0}}async function he(){P.value=null,d.portal=!0;try{const e=(await w(K,He,{returnUrl:window.location.origin+"/profile-page"}))?.createBillingPortal?.url;if(!e)throw new Error("No portal URL returned");window.location.href=e}catch(o){P.value=o?.message||"Failed to open billing portal",T.error(P.value)}finally{d.portal=!1}}function we(){T.info("This button is a placeholder for a dev/test invoice action.")}async function ae(){A.value=null,d.save=!0;try{const o={name:y.name||c.name||"",title:y.title||"",bio:y.bio||""},e=await w(ne,Xe,{input:o});e?.updateProfile?(c.name=e.updateProfile.name||c.name,T.success("Profile updated")):T.success("Settings saved (local only)")}catch(o){A.value=o?.message||"Failed to save settings",T.error(A.value)}finally{d.save=!1}}function be(){y.name=c.name||"",y.title="",y.bio=""}return Ue(async()=>{ge(),await fe(),await Promise.all([ye(),ve()])}),(o,e)=>{const m=l("a-tag"),p=l("a-button"),u=l("a-space"),v=l("a-avatar"),O=l("a-descriptions-item"),ke=l("a-descriptions"),Ie=l("a-page-header"),q=l("a-statistic"),h=l("a-col"),B=l("a-row"),L=l("a-card"),M=l("a-empty"),oe=l("a-list"),R=l("a-tab-pane"),D=l("a-alert"),se=l("a-skeleton"),Se=l("a-image"),Ce=l("a-progress"),Le=l("a-table"),Ee=l("a-typography-paragraph"),le=l("a-input"),j=l("a-form-item"),xe=l("a-textarea"),Pe=l("a-form"),Ae=l("a-tabs");return s(),b("div",Me,[a(Ie,{class:"profile-header",title:"Your Profile","sub-title":J.value||"Welcome to Byway"},{tags:t(()=>[x.value?(s(),n(m,{key:0,color:"blue"},{default:t(()=>[...e[4]||(e[4]=[_("Logged In",-1)])]),_:1})):(s(),n(m,{key:1,color:"red"},{default:t(()=>[...e[5]||(e[5]=[_("Guest",-1)])]),_:1}))]),extra:t(()=>[a(u,null,{default:t(()=>[x.value?k("",!0):(s(),n(p,{key:0,type:"primary",href:"/auth/login"},{default:t(()=>[...e[6]||(e[6]=[_("Log in",-1)])]),_:1})),x.value?(s(),n(p,{key:1,onClick:ce,danger:""},{default:t(()=>[...e[7]||(e[7]=[_("Logout",-1)])]),_:1})):k("",!0)]),_:1})]),avatar:t(()=>[a(v,{size:64,src:c.avatar||"/user.png"},null,8,["src"])]),default:t(()=>[a(ke,{column:2,size:"small",class:"profile-desc"},{default:t(()=>[a(O,{label:"Name"},{default:t(()=>[_(f(c.name||"—"),1)]),_:1}),a(O,{label:"Email"},{default:t(()=>[_(f(J.value||"—"),1)]),_:1}),a(O,{label:"Member Since"},{default:t(()=>[_(f(N.value||"—"),1)]),_:1}),a(O,{label:"Role"},{default:t(()=>[_(f(c.role||"Student"),1)]),_:1})]),_:1})]),_:1},8,["sub-title"]),a(L,{class:"stats-card",bordered:!0},{default:t(()=>[a(B,{gutter:[16,16]},{default:t(()=>[a(h,{xs:12,md:6},{default:t(()=>[a(q,{title:"Enrolled Courses",value:g.enrolled},null,8,["value"])]),_:1}),a(h,{xs:12,md:6},{default:t(()=>[a(q,{title:"Orders",value:g.orders},null,8,["value"])]),_:1}),a(h,{xs:12,md:6},{default:t(()=>[a(q,{title:"Wishlist",value:g.wishlist},null,8,["value"])]),_:1}),a(h,{xs:12,md:6},{default:t(()=>[a(q,{title:"Completed Lessons",value:g.completedLessons},null,8,["value"])]),_:1})]),_:1})]),_:1}),a(L,{class:"body-card",bordered:!0},{default:t(()=>[a(Ae,{activeKey:W.value,"onUpdate:activeKey":e[3]||(e[3]=r=>W.value=r)},{default:t(()=>[a(R,{key:"overview",tab:"Overview"},{default:t(()=>[a(B,{gutter:[16,16]},{default:t(()=>[a(h,{xs:24,lg:12},{default:t(()=>[a(L,{title:"Recent Courses",loading:d.courses},{default:t(()=>[H.value.length?(s(),n(oe,{key:1,"item-layout":"horizontal","data-source":H.value,renderItem:pe},null,8,["data-source"])):(s(),n(M,{key:0,description:"No recent courses yet"}))]),_:1},8,["loading"])]),_:1}),a(h,{xs:24,lg:12},{default:t(()=>[a(L,{title:"Recent Orders",loading:d.orders},{default:t(()=>[X.value.length?(s(),n(oe,{key:1,"item-layout":"horizontal","data-source":X.value,renderItem:me},null,8,["data-source"])):(s(),n(M,{key:0,description:"No orders yet"}))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1}),a(R,{key:"courses",tab:"My Courses"},{default:t(()=>[x.value?k("",!0):(s(),n(D,{key:0,type:"info","show-icon":"",message:"Log in to see your enrolled courses.",style:{"margin-bottom":"12px"}})),d.courses?(s(),n(se,{key:1,active:"",paragraph:{rows:5}})):(s(),b(z,{key:2},[$.value.length?k("",!0):(s(),n(M,{key:0,description:"You have no enrollments yet"})),a(B,{gutter:[16,16]},{default:t(()=>[(s(!0),b(z,null,re($.value,r=>(s(),n(h,{key:r.id,xs:24,md:12,lg:8},{default:t(()=>[a(L,{class:"course-card",hoverable:!0,onClick:I=>te(r.id)},{default:t(()=>[a(Se,{src:r.thumb||"/course-thumb.jpg",class:"course-thumb",preview:!1},null,8,["src"]),F("div",De,[F("div",Ge,f(r.title),1),F("div",ze,f(r.category||"—")+" · "+f(r.level||"All levels"),1),a(Ce,{percent:r.progress?.percent||0,size:"small",status:"active"},null,8,["percent"]),F("div",Fe,f(r.progress?.completedLessons||0)+"/"+f(r.progress?.totalLessons||0)+" lessons ",1)])]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],64))]),_:1}),a(R,{key:"orders",tab:"Orders & Invoices"},{default:t(()=>[x.value?k("",!0):(s(),n(D,{key:0,type:"info","show-icon":"",message:"Log in to see your orders.",style:{"margin-bottom":"12px"}})),d.orders?(s(),n(se,{key:1,active:"",paragraph:{rows:5}})):(s(),b(z,{key:2},[C.value.length?(s(),n(Le,{key:1,"data-source":C.value,columns:_e,"row-key":"id",size:"middle",pagination:{pageSize:5}},{bodyCell:t(({column:r,record:I})=>[r.key==="items"?(s(),n(u,{key:0,direction:"vertical",size:"small"},{default:t(()=>[(s(!0),b(z,null,re(I.items||[],(Y,Oe)=>(s(),b("div",{key:Oe,class:"muted"},f(Y.title||Y.courseId)+" × "+f(Y.quantity||1),1))),128))]),_:2},1024)):r.key==="total"?(s(),b("span",Qe,f(Z(I.total||0,I.currency||"EUR")),1)):r.key==="createdAt"?(s(),b("span",je,f(Q(I.createdAt)),1)):r.key==="status"?(s(),n(m,{key:3,color:ee(I.status)},{default:t(()=>[_(f(I.status),1)]),_:2},1032,["color"])):k("",!0)]),_:1},8,["data-source"])):(s(),n(M,{key:0,description:"You don't have any orders yet"}))],64))]),_:1}),a(R,{key:"billing",tab:"Billing"},{default:t(()=>[a(L,{title:"Payment Methods & Invoices"},{default:t(()=>[a(u,{direction:"vertical",style:{width:"100%"}},{default:t(()=>[a(Ee,null,{default:t(()=>[...e[8]||(e[8]=[_(" Manage your payment methods, invoices and subscriptions through the Stripe customer portal. ",-1)])]),_:1}),a(u,null,{default:t(()=>[a(p,{type:"primary",loading:d.portal,onClick:he},{default:t(()=>[...e[9]||(e[9]=[_(" Open Stripe Portal ",-1)])]),_:1},8,["loading"]),a(p,{loading:d.portal,onClick:we},{default:t(()=>[...e[10]||(e[10]=[_(" Create Test Invoice (dev) ",-1)])]),_:1},8,["loading"])]),_:1}),P.value?(s(),n(D,{key:0,type:"error",message:P.value,"show-icon":"",style:{"margin-top":"8px"}},null,8,["message"])):k("",!0)]),_:1})]),_:1})]),_:1}),a(R,{key:"settings",tab:"Settings"},{default:t(()=>[a(Pe,{layout:"vertical",class:"settings-form",onSubmit:Ne(ae,["prevent"])},{default:t(()=>[a(B,{gutter:[16,16]},{default:t(()=>[a(h,{xs:24,md:12},{default:t(()=>[a(j,{label:"Full Name"},{default:t(()=>[a(le,{value:y.name,"onUpdate:value":e[0]||(e[0]=r=>y.name=r),placeholder:"Your full name"},null,8,["value"])]),_:1})]),_:1}),a(h,{xs:24,md:12},{default:t(()=>[a(j,{label:"Public Title"},{default:t(()=>[a(le,{value:y.title,"onUpdate:value":e[1]||(e[1]=r=>y.title=r),placeholder:"e.g. Frontend Developer"},null,8,["value"])]),_:1})]),_:1}),a(h,{xs:24},{default:t(()=>[a(j,{label:"Bio"},{default:t(()=>[a(xe,{value:y.bio,"onUpdate:value":e[2]||(e[2]=r=>y.bio=r),rows:4,placeholder:"Tell others about you…"},null,8,["value"])]),_:1})]),_:1})]),_:1}),a(u,null,{default:t(()=>[a(p,{type:"primary",loading:d.save,onClick:ae},{default:t(()=>[...e[11]||(e[11]=[_("Save",-1)])]),_:1},8,["loading"]),a(p,{onClick:be},{default:t(()=>[...e[12]||(e[12]=[_("Reset",-1)])]),_:1})]),_:1}),A.value?(s(),n(D,{key:0,message:A.value,type:"error","show-icon":"",style:{"margin-top":"8px"}},null,8,["message"])):k("",!0)]),_:1})]),_:1})]),_:1},8,["activeKey"])]),_:1})])}}}),ot=qe(Ze,[["__scopeId","data-v-1fb6b729"]]);export{ot as default};
