import{_ as E}from"./Cv_gb3jg.js";import{u as V}from"./CLh6bXrM.js";import{u as Y}from"./CI-SnmTa.js";import{g as j,ar as D,U as z,W as L,r as M,k as J,n as s,l as x,q as K,w as o,p as n,o as b,b as t,d as c,a as i,c as Q,K as W,x as y,m as I,t as G,as as H,at as X,_ as Z}from"./DQDUwbr-.js";const ee={class:"grid md:grid-cols-3 gap-4"},te={class:"md:col-span-2"},ae={key:0,class:"empty-cart"},oe={class:"text-2xl font-semibold"},se=j({__name:"cart",setup(re){const v=D();z();const $=L().public?.apiBase||"http://localhost:4000",{user:h,isLoggedIn:k,token:C}=Y(),{loading:_,items:f,totalPrice:U,fetchCart:B,removeFromCart:R,clearCart:S}=V(),u=M(!1);J(async()=>{if(k.value&&h.value?.id)try{await B()}catch(a){s.error(a?.message||"Failed to load cart")}else s.warning("Please log in to view your cart"),v.push("/login")});const g=x(()=>f.value||[]),q=[{title:"Course",dataIndex:"titleSnapshot",key:"title"},{title:"Quantity",dataIndex:"quantity",key:"quantity"},{title:"Price",key:"price",customRender:({record:a})=>`€${(a.priceSnapshot||0).toFixed(2)}`},{title:"Action",key:"action",customRender:({record:a})=>I("a",{onClick:()=>T(a),style:"color: #f5222d; cursor: pointer;"},[I(H)," Remove"])}],F=x(()=>U.value||0);async function T(a){try{await R(a.id),s.success("Item removed from cart")}catch(e){s.error(e?.message||"Failed to remove item")}}async function N(){X.confirm({title:"Clear Cart?",content:"Are you sure you want to remove all items from your cart?",okText:"Clear",okType:"danger",cancelText:"Cancel",onOk:async()=>{try{await S(),s.success("Cart cleared")}catch(a){s.error(a?.message||"Failed to clear cart")}}})}async function A(){if(f.value.length===0){s.warning("Your cart is empty");return}if(!k.value||!h.value?.id){s.warning("Please log in to checkout"),v.push("/login");return}u.value=!0;try{const a=`${window.location.origin}/checkout/success`,e=`${window.location.origin}/cart`,r={query:`mutation($items:[EcCartItemInput!]!,$successUrl:String!,$cancelUrl:String!){
        createCheckout(items:$items, successUrl:$successUrl, cancelUrl:$cancelUrl){ url orderId }
      }`,variables:{items:f.value.map(p=>({courseId:p.courseId,quantity:p.quantity||1})),successUrl:a,cancelUrl:e}},l=await(await fetch(`${$}/api/ecommerce/graphql`,{method:"POST",headers:{"Content-Type":"application/json",...C.value?{Authorization:`Bearer ${C.value}`}:{}},body:JSON.stringify(r)})).json();if(l.errors?.length)throw new Error(l.errors[0].message);const m=l?.data?.createCheckout?.url;m?window.location.href=m:s.error("Checkout link unavailable. Try again.")}catch(a){const e=a?.message||"Failed to start checkout";e.includes("Already enrolled")?s.info("You already own one of these courses."):s.error(e)}finally{u.value=!1}}return(a,e)=>{const r=n("a-button"),d=E,l=n("a-space"),m=n("a-page-header"),p=n("a-table"),O=n("a-divider"),w=n("a-card"),P=n("a-layout");return b(),K(P,{class:"p-6"},{default:o(()=>[t(m,{title:"Your Cart","sub-title":"Review and checkout",class:"mb-4"},{extra:o(()=>[t(l,null,{default:o(()=>[t(d,{to:"/"},{default:o(()=>[t(r,null,{default:o(()=>[...e[0]||(e[0]=[c("Explore",-1)])]),_:1})]),_:1}),t(d,{to:"/students/dashboard"},{default:o(()=>[t(r,null,{default:o(()=>[...e[1]||(e[1]=[c("Dashboard",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),t(w,{bordered:!1},{default:o(()=>[i("div",ee,[i("div",te,[t(p,{"data-source":g.value,columns:q,"row-key":"id",loading:y(_)},null,8,["data-source","loading"]),!g.value.length&&!y(_)?(b(),Q("div",ae,[e[3]||(e[3]=i("div",null,"Your cart is empty.",-1)),t(d,{to:"/categories"},{default:o(()=>[t(r,{type:"primary",style:{"margin-top":"12px"}},{default:o(()=>[...e[2]||(e[2]=[c("Browse courses",-1)])]),_:1})]),_:1})])):W("",!0)]),i("div",null,[t(w,{size:"small",title:"Summary"},{default:o(()=>[i("div",oe,"€"+G(F.value.toFixed(2)),1),t(O),t(l,null,{default:o(()=>[t(r,{onClick:N,loading:y(_)},{default:o(()=>[...e[4]||(e[4]=[c("Clear",-1)])]),_:1},8,["loading"]),t(r,{type:"primary",onClick:A,disabled:!g.value.length||u.value,loading:u.value},{default:o(()=>[...e[5]||(e[5]=[c("Checkout",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})])])]),_:1})]),_:1})}}}),de=Z(se,[["__scopeId","data-v-76804127"]]);export{de as default};
