import{H as Re}from"./CN_SqyUH.js";import{u as Je}from"./CI-SnmTa.js";import{u as Ge}from"./CLh6bXrM.js";import{g as He,ar as Qe,W as We,r as v,b4 as Ke,l as V,k as Ye,c as i,b as l,w as o,x as m,I as f,p as d,o as s,L as Xe,a as u,q as p,K as h,b5 as Ze,d as n,t as c,J as W,b3 as ye,aF as _e,n as S,_ as et}from"./DQDUwbr-.js";import{t as he}from"./DFP984fK.js";import"./Cv_gb3jg.js";const tt={},at={class:"filters"},ot={class:"chips"},lt={key:0,class:"results"},st={key:0,class:"badge"},nt={class:"meta"},rt=["title"],it={class:"tags"},ut={class:"stats"},dt={class:"price-row"},ct={key:0,class:"price"},ft={key:0,class:"muted small"},pt={key:1,class:"price"},vt={class:"actions"},gt={key:2,class:"list-wrap"},mt={class:"list-title"},yt={class:"list-desc"},_t={class:"list-actions"},ht={class:"list-price"},kt={key:0,class:"muted small",style:{"margin-left":"6px"}},wt={key:3,class:"pagi"},bt={key:1,class:"results"},Ct=He({__name:"course-listing",setup(St){const z=Qe(),K=We().public?.apiBase||"http://localhost:4000",{user:$,token:I,isLoggedIn:ne}=Je(),{addToCart:re,isInCart:F,fetchCart:ie,loading:ue,itemCount:de}=Ge(),T=v(null),b=v(!1);function ke(){b.value=!b.value,console.debug("setItem replaced"),JSON.stringify(b.value)}const we=tt?.VITE_API_URL||"http://localhost:4000/api/teach-internal/graphql",j=v(!1),A=v([]);async function ce(){j.value=!0;try{const a=`
      query Courses {
        courses {
          id title category difficulty description price discount coverUrl isEnrolled
          modules { lessons { id duration preview } }
        }
      }`,e={"content-type":"application/json"};I.value&&(e.Authorization=`Bearer ${I.value}`);const r=await fetch(we,{method:"POST",credentials:"include",headers:e,body:JSON.stringify({query:a})}),{data:w,errors:_}=await r.json();if(_)throw new Error(_[0]?.message||"GraphQL error");A.value=w?.courses||[]}catch(a){console.warn("Falling back to demo seed:",a?.message||a),A.value=Ce}finally{j.value=!1}}function be(){ce()}const Ce=[{id:"c1",title:"Advanced Vue 3 Workshop",category:"Programming",difficulty:"Intermediate",description:"Build a production-grade dashboard with Vue 3.",price:69,discount:20,coverUrl:"",modules:[{lessons:[{id:"l1",duration:8},{id:"l2",duration:12}]}]},{id:"c2",title:"Shopware for Developers",category:"E-commerce",difficulty:"Advanced",description:"Extend Shopware with plugins and headless storefronts.",price:99,discount:0,coverUrl:"",modules:[{lessons:[{id:"l1",duration:20},{id:"l2",duration:15},{id:"l3",duration:30}]}]},{id:"c3",title:"GraphQL + Prisma Basics",category:"Programming",difficulty:"Beginner",description:"CRUD, resolvers, paging, and auth with Prisma.",price:0,discount:0,coverUrl:"",modules:[{lessons:[{id:"l1",duration:10},{id:"l2",duration:10}]}]}],Y=v(""),D=v(),M=v(),X=v(!1),Z=v(!1),ee=v(!1),te=v("popular"),R=v(Se());function Se(){try{return"grid"}catch{return"grid"}}function $e(){try{console.debug("setItem replaced"),R.value}catch{}}Ke($e);function Ie(){}const Ue=V(()=>Array.from(new Set(A.value.map(a=>a.category).filter(Boolean)))),xe=V(()=>Array.from(new Set(A.value.map(a=>a.difficulty).filter(Boolean))));function y(a){return!!a.isEnrolled}function U(a){return(a.price||0)<=0}function Pe(a){return a.price*(1-(a.discount||0)/100)}function x(a){return qe(Pe(a))}function J(a){return(a.modules||[]).reduce((e,r)=>e+(r.lessons?.length||0),0)}function G(a){return(a.modules||[]).flatMap(e=>e.lessons||[]).reduce((e,r)=>e+(r.duration||0),0)}const L=V(()=>{const a=Y.value.trim().toLowerCase();return A.value.filter(e=>!(D.value&&e.category!==D.value||M.value&&e.difficulty!==M.value||X.value&&!U(e)||Z.value&&!(e.discount&&e.discount>0)||ee.value&&!y(e)||a&&!`${e.title} ${e.category||""} ${e.difficulty||""} ${e.description||""}`.toLowerCase().includes(a)))}),Be=V(()=>{const a=[...L.value];switch(te.value){case"price-asc":a.sort((e,r)=>x(e)-x(r));break;case"price-desc":a.sort((e,r)=>x(r)-x(e));break;case"length-desc":a.sort((e,r)=>G(r)-G(e));break;case"newest":a.sort((e,r)=>(r.id||"").localeCompare(e.id||""));break;default:a.sort((e,r)=>J(r)-J(e));break}return a}),N=v(1),q=v(12),ae=V(()=>{const a=(N.value-1)*q.value;return Be.value.slice(a,a+q.value)});function ze(a){N.value=a,fe()}function Ae(a,e){N.value=1,q.value=e,fe()}function fe(){try{window.scrollTo({top:0,behavior:"smooth"})}catch{}}function pe(a){return a.coverUrl?{backgroundImage:`url('${a.coverUrl}')`}:{backgroundImage:"linear-gradient(135deg,#1e293b,#0ea5e9)"}}async function ve(a){if(!ne.value||!$.value?.id){S.warning("Please log in to add courses to your cart"),z.push("/login");return}try{await re(a.id,1),S.success(`Added "${a.title}" to cart`),await ie()}catch(e){S.error(e?.message||"Failed to add to cart")}}const H=v(null);async function ge(a){if(y(a)){P(a);return}if(!ne.value||!$.value?.id){S.warning("Please log in to purchase courses"),z.push("/login");return}const e=await Le();H.value=a.id;try{const r=`${window.location.origin}/checkout/success`,w=`${window.location.origin}/categories`,B=await(await fetch(`${K}/api/ecommerce/graphql`,{method:"POST",headers:{"content-type":"application/json",...I.value?{Authorization:`Bearer ${I.value}`}:{}},body:JSON.stringify({query:`
          mutation($items:[EcCartItemInput!]!, $successUrl:String!, $cancelUrl:String!) {
            createCheckout(items:$items, successUrl:$successUrl, cancelUrl:$cancelUrl, studentId:$studentId, email:$email) { url orderId }
          }`,variables:{items:[{courseId:a.id,quantity:1}],successUrl:r,cancelUrl:w,studentId:e,email:$.value?.email||null}})})).json();if(B.errors?.length)throw new Error(B.errors[0].message);const E=B?.data?.createCheckout?.url;if(E)window.location.href=E;else{try{await re(a.id,1),await ie()}catch(g){console.warn("[checkout fallback] addToCart failed",g?.message||g)}S.warning("Checkout link not available, opening cart instead."),z.push("/cart")}}catch(r){const w=r?.message||"Unable to start checkout";w.includes("Already enrolled")?(S.info("You already own this course — opening it instead."),P(a)):S.error(w)}finally{H.value=null}}async function Le(){if(T.value)return T.value;const a=$.value?.userId||$.value?.id;if(!a)throw new Error("Not authenticated");const e={"content-type":"application/json"};I.value&&(e.Authorization=`Bearer ${I.value}`);try{const g=(await(await fetch(`${K}/api/students-internal/graphql`,{method:"POST",headers:e,body:JSON.stringify({query:"query($uid:String!){ studentByUserId(userId:$uid){ id } }",variables:{uid:a}})})).json())?.data?.studentByUserId?.id;if(g)return T.value=g,g}catch{}const _=(await(await fetch(`${K}/api/students-internal/graphql`,{method:"POST",headers:e,body:JSON.stringify({query:"mutation($uid:String!,$name:String){ createStudent(userId:$uid, displayName:$name){ id } }",variables:{uid:a,name:$.value?.email||"Student"}})})).json())?.data?.createStudent?.id;if(!_)throw new Error("Student profile not found");return T.value=_,_}function P(a){z.push(`/course/${encodeURIComponent(a.id)}`)}function Ne(){z.push("/cart")}function qe(a){return Math.round(a*100)/100}function Q(a){return a.toLocaleString(void 0,{style:"currency",currency:"EUR"})}return Ye(()=>{try{b.value=JSON.parse("false")}catch{}ce()}),(a,e)=>{const r=d("a-button"),w=d("a-tooltip"),_=d("a-space"),B=d("a-page-header"),E=d("a-input-search"),g=d("a-col"),C=d("a-select-option"),oe=d("a-select"),Ee=d("a-segmented"),le=d("a-row"),se=d("a-checkbox"),Oe=d("a-empty"),k=d("a-tag"),me=d("a-card"),Ve=d("a-list-item-meta"),Fe=d("a-list-item"),Te=d("a-list"),je=d("a-pagination"),De=d("a-layout"),Me=d("a-config-provider");return s(),i(f,null,[l(Re),l(Me,{theme:{algorithm:b.value?m(he).darkAlgorithm:m(he).defaultAlgorithm}},{default:o(()=>[l(De,{class:Xe(["course-listing",b.value?"is-dark":""])},{default:o(()=>[l(B,{class:"header",title:"Browse Courses","sub-title":`${L.value.length} result${L.value.length===1?"":"s"}`},{extra:o(()=>[l(_,null,{default:o(()=>[l(w,{title:b.value?"Switch to light":"Switch to dark"},{default:o(()=>[l(r,{shape:"circle",onClick:ke},{default:o(()=>[l(m(Ze))]),_:1})]),_:1},8,["title"]),m(de)>0?(s(),p(r,{key:0,type:"primary",ghost:"",onClick:Ne},{default:o(()=>[n(" Cart ("+c(m(de))+") ",1)]),_:1})):h("",!0),l(r,{shape:"circle",onClick:be,loading:j.value,title:"Refresh"},{default:o(()=>[...e[9]||(e[9]=[u("svg",{viewBox:"0 0 24 24",width:"1em",height:"1em"},[u("path",{fill:"currentColor",d:"M12 6V3L8 7l4 4V8a4 4 0 1 1-4 4H6a6 6 0 1 0 6-6z"})],-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["sub-title"]),u("div",at,[l(le,{gutter:[12,12],align:"middle"},{default:o(()=>[l(g,{xs:24,md:10,lg:12},{default:o(()=>[l(E,{value:Y.value,"onUpdate:value":e[0]||(e[0]=t=>Y.value=t),placeholder:"Search by title, category…","allow-clear":"",onSearch:Ie},null,8,["value"])]),_:1}),l(g,{xs:12,md:6,lg:4},{default:o(()=>[l(oe,{value:D.value,"onUpdate:value":e[1]||(e[1]=t=>D.value=t),"allow-clear":"",placeholder:"Category",style:{width:"100%"}},{default:o(()=>[(s(!0),i(f,null,W(Ue.value,t=>(s(),p(C,{key:t,value:t},{default:o(()=>[n(c(t),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(g,{xs:12,md:4,lg:4},{default:o(()=>[l(oe,{value:M.value,"onUpdate:value":e[2]||(e[2]=t=>M.value=t),"allow-clear":"",placeholder:"Difficulty",style:{width:"100%"}},{default:o(()=>[(s(!0),i(f,null,W(xe.value,t=>(s(),p(C,{key:t,value:t},{default:o(()=>[n(c(t),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),l(g,{xs:24,md:4,lg:4,class:"right-controls"},{default:o(()=>[l(Ee,{value:R.value,"onUpdate:value":e[3]||(e[3]=t=>R.value=t),options:[{label:"Grid",value:"grid"},{label:"List",value:"list"}],size:"small"},null,8,["value"])]),_:1})]),_:1}),u("div",ot,[l(se,{checked:X.value,"onUpdate:checked":e[4]||(e[4]=t=>X.value=t)},{default:o(()=>[...e[10]||(e[10]=[n("Free",-1)])]),_:1},8,["checked"]),l(se,{checked:Z.value,"onUpdate:checked":e[5]||(e[5]=t=>Z.value=t)},{default:o(()=>[...e[11]||(e[11]=[n("Discounted",-1)])]),_:1},8,["checked"]),l(se,{checked:ee.value,"onUpdate:checked":e[6]||(e[6]=t=>ee.value=t)},{default:o(()=>[...e[12]||(e[12]=[n("Purchased",-1)])]),_:1},8,["checked"]),l(oe,{value:te.value,"onUpdate:value":e[7]||(e[7]=t=>te.value=t),size:"small",style:{"min-width":"180px","margin-left":"auto"}},{default:o(()=>[l(C,{value:"popular"},{default:o(()=>[...e[13]||(e[13]=[n("Most popular",-1)])]),_:1}),l(C,{value:"newest"},{default:o(()=>[...e[14]||(e[14]=[n("Newest",-1)])]),_:1}),l(C,{value:"price-asc"},{default:o(()=>[...e[15]||(e[15]=[n("Price ↑",-1)])]),_:1}),l(C,{value:"price-desc"},{default:o(()=>[...e[16]||(e[16]=[n("Price ↓",-1)])]),_:1}),l(C,{value:"length-desc"},{default:o(()=>[...e[17]||(e[17]=[n("Longest",-1)])]),_:1})]),_:1},8,["value"])])]),j.value?(s(),i("div",bt,[l(le,{gutter:[16,16]},{default:o(()=>[(s(),i(f,null,W(8,t=>l(g,{key:t,xs:24,sm:12,md:12,lg:8,xl:6},{default:o(()=>[l(me,{loading:!0,"body-style":{padding:"12px"}},{default:o(()=>[...e[24]||(e[24]=[u("div",{style:{height:"150px",background:"#f0f2f5","border-radius":"8px"}},null,-1)])]),_:1})]),_:1})),64))]),_:1})])):(s(),i("div",lt,[ae.value.length===0?(s(),p(Oe,{key:0,description:"No matching courses."})):R.value==="grid"?(s(),p(le,{key:1,gutter:[16,16]},{default:o(()=>[(s(!0),i(f,null,W(ae.value,t=>(s(),p(g,{key:t.id,xs:24,sm:12,md:12,lg:8,xl:6},{default:o(()=>[l(me,{class:"course-card",hoverable:!0,"body-style":{padding:"12px"}},{default:o(()=>[u("div",{class:"cover",style:ye(pe(t))},[t.discount||U(t)?(s(),i("div",st,[U(t)?(s(),p(k,{key:0,color:"green"},{default:o(()=>[...e[18]||(e[18]=[n("Free",-1)])]),_:1})):(s(),p(k,{key:1,color:"red"},{default:o(()=>[n(c(t.discount)+"% off",1)]),_:2},1024))])):h("",!0),y(t)?(s(),p(k,{key:1,color:"green",class:"purchased-tag"},{default:o(()=>[...e[19]||(e[19]=[n("Purchased",-1)])]),_:1})):h("",!0)],4),u("div",nt,[u("div",{class:"title",title:t.title},c(t.title),9,rt),u("div",it,[t.category?(s(),p(k,{key:0,color:"blue"},{default:o(()=>[n(c(t.category),1)]),_:2},1024)):h("",!0),t.difficulty?(s(),p(k,{key:1,color:"gold"},{default:o(()=>[n(c(t.difficulty),1)]),_:2},1024)):h("",!0)]),u("div",ut,[u("span",null,[l(m(_e)),n(" "+c(G(t))+" min",1)]),u("span",null,"• "+c(J(t))+" lessons",1)]),u("div",dt,[U(t)?(s(),i("span",pt,"Free")):(s(),i("span",ct,[n(c(Q(x(t)))+" ",1),t.discount?(s(),i("del",ft,c(Q(t.price)),1)):h("",!0)]))]),u("div",vt,[l(_,null,{default:o(()=>[l(r,{onClick:O=>P(t)},{default:o(()=>[...e[20]||(e[20]=[n("View",-1)])]),_:1},8,["onClick"]),l(r,{onClick:O=>ve(t),disabled:y(t)||m(F)(t.id),loading:m(ue)},{default:o(()=>[y(t)?(s(),i(f,{key:0},[n("Purchased")],64)):m(F)(t.id)?(s(),i(f,{key:1},[n("In Cart")],64)):(s(),i(f,{key:2},[n("Add to cart")],64))]),_:2},1032,["onClick","disabled","loading"]),l(r,{type:"primary",onClick:O=>y(t)?P(t):ge(t),loading:H.value===t.id},{default:o(()=>[y(t)?(s(),i(f,{key:0},[n("Continue")],64)):(s(),i(f,{key:1},[n("Buy")],64))]),_:2},1032,["onClick","loading"])]),_:2},1024)])])]),_:2},1024)]),_:2},1024))),128))]),_:1})):(s(),i("div",gt,[l(Te,{"data-source":ae.value,"item-layout":"horizontal",bordered:""},{renderItem:o(({item:t})=>[(s(),p(Fe,{key:t.id},{actions:o(()=>[u("div",_t,[u("span",ht,[U(t)?(s(),i(f,{key:0},[n("Free")],64)):(s(),i(f,{key:1},[n(c(Q(x(t)))+" ",1),t.discount?(s(),i("del",kt,c(Q(t.price)),1)):h("",!0)],64))]),l(_,null,{default:o(()=>[l(r,{onClick:O=>P(t)},{default:o(()=>[...e[23]||(e[23]=[n("View",-1)])]),_:1},8,["onClick"]),l(r,{onClick:O=>ve(t),disabled:y(t)||m(F)(t.id),loading:m(ue)},{default:o(()=>[y(t)?(s(),i(f,{key:0},[n("Purchased")],64)):m(F)(t.id)?(s(),i(f,{key:1},[n("In Cart")],64)):(s(),i(f,{key:2},[n("Add to cart")],64))]),_:2},1032,["onClick","disabled","loading"]),l(r,{type:"primary",onClick:O=>y(t)?P(t):ge(t),loading:H.value===t.id},{default:o(()=>[y(t)?(s(),i(f,{key:0},[n("Continue")],64)):(s(),i(f,{key:1},[n("Buy")],64))]),_:2},1032,["onClick","loading"])]),_:2},1024)])]),default:o(()=>[l(Ve,null,{avatar:o(()=>[u("div",{class:"list-cover",style:ye(pe(t))},null,4)]),title:o(()=>[u("div",mt,[u("span",null,c(t.title),1),t.category?(s(),p(k,{key:0,color:"blue",style:{"margin-left":"8px"}},{default:o(()=>[n(c(t.category),1)]),_:2},1024)):h("",!0),t.difficulty?(s(),p(k,{key:1,color:"gold"},{default:o(()=>[n(c(t.difficulty),1)]),_:2},1024)):h("",!0),y(t)?(s(),p(k,{key:2,color:"green"},{default:o(()=>[...e[21]||(e[21]=[n("Purchased",-1)])]),_:1})):U(t)?(s(),p(k,{key:3,color:"green"},{default:o(()=>[...e[22]||(e[22]=[n("Free",-1)])]),_:1})):t.discount?(s(),p(k,{key:4,color:"red"},{default:o(()=>[n(c(t.discount)+"% off",1)]),_:2},1024)):h("",!0)])]),description:o(()=>[u("div",yt,[u("span",null,[l(m(_e)),n(" "+c(G(t))+" min",1)]),u("span",null,"• "+c(J(t))+" lessons",1)])]),_:2},1024)]),_:2},1024))]),_:1},8,["data-source"])])),L.value.length>q.value?(s(),i("div",wt,[l(je,{current:N.value,"onUpdate:current":e[8]||(e[8]=t=>N.value=t),total:L.value.length,pageSize:q.value,"show-size-changer":"",pageSizeOptions:["8","12","16","24","32"],onChange:ze,onShowSizeChange:Ae},null,8,["current","total","pageSize"])])):h("",!0)]))]),_:1},8,["class"])]),_:1},8,["theme"])],64)}}}),At=et(Ct,[["__scopeId","data-v-631ee27d"]]);export{At as default};
