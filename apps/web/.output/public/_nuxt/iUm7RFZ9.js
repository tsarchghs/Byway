import{g as X,U as Y,W as Z,l as D,r as u,k as J,c as x,b as i,w as s,n as ee,p as c,o as g,q as U,K as P,a as h,d as R,I as te,_ as ae}from"./DQDUwbr-.js";const ne={class:"catalog-page"},oe=["href"],se=["href"],ie=["href"],re=["href"],le=["href"],ce=["href"],ue=["href"],de=["href"],pe=X({__name:"index",setup(fe){const q=Y(),j=Z(),p=j.public?.apiBase||j.public?.appBaseUrl||"",I=D(()=>q.query.institutionId||q.params?.institution_id||"inst_byway"),$=u(!0),w=u(""),b=u(void 0),B=u([]),z=u({}),y=u("none"),E=u(null),O=u([]),k=u(null),C=u(null);function T(){if(typeof window>"u")return null;const e=localStorage.getItem("token")||localStorage.getItem("access_token")||"";return e?e.startsWith("Bearer")?e:`Bearer ${e}`:null}async function N(){$.value=!0;try{const e=T();if(!e)throw new Error("Missing auth token");const t=p?p.replace(/\/$/,""):"",n=`${t}/api/institution-portal/catalog?institutionId=${encodeURIComponent(I.value)}`,r=await fetch(n,{headers:{Authorization:e}});let a=null;if(r.ok)a=await r.json();else{const o=await fetch(`${t}/api/teach-internal/courses`,{headers:{Authorization:e}});if(!o.ok)throw new Error(await o.text().catch(()=>`HTTP ${o.status}`));const l=await o.json().catch(()=>({}));a={courses:(Array.isArray(l?.data)?l.data:[]).map(d=>({courseId:d.id,title:d.title,teacherId:d.teacherId||null,category:d.category||null,difficulty:d.difficulty||null,availability:"available"}))}}B.value=a.courses||[],await F(e),await H(e)}catch(e){ee.error(e?.message||"Failed to load catalog")}finally{$.value=!1}}J(N),J(W);const L=D(()=>B.value.filter(e=>b.value?e.difficulty===b.value:!0).filter(e=>w.value?String(e.title).toLowerCase().includes(w.value.toLowerCase()):!0)),M=[{label:"Beginner",value:"beginner"},{label:"Intermediate",value:"intermediate"},{label:"Advanced",value:"advanced"}],V=[{title:"Course",dataIndex:"title",key:"title"},{title:"Teacher",dataIndex:"teacherId",key:"teacherId"},{title:"Category",dataIndex:"category",key:"category"},{title:"Difficulty",dataIndex:"difficulty",key:"difficulty"},{title:"Availability",dataIndex:"availability",key:"availability"},{title:"Actions",key:"actions"}];async function F(e){try{const t=p?p.replace(/\/$/,""):"",n=await fetch(`${t}/api/teach-internal/modules`,{headers:{Authorization:e}});if(!n.ok)return;const r=await n.json().catch(()=>null),a=Array.isArray(r)?r:Array.isArray(r?.modules)?r.modules:[],o={};a.forEach(l=>{const f=l.courseId||l.course_id||"";f&&(o[f]=o[f]||[],o[f].push(l))}),z.value=o}catch{}}async function H(e){try{const t=p?p.replace(/\/$/,""):"",r=await(await fetch(`${t}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query($institutionId:String!){ classrooms(institutionId:$institutionId){ id departmentId teacherId } }",variables:{institutionId:I.value}})})).json().catch(()=>null),a=Array.isArray(r?.data?.classrooms)?r.data.classrooms:[];O.value=Array.from(new Set(a.map(o=>String(o.teacherId||"")).filter(Boolean))),C.value=a[0]?.id||null,k.value=a.find(o=>o.departmentId)?.departmentId||null}catch{}}function K(e){const t=e.courseId||e.id,n=e.teacherId||e.teacher_id||"teacher",a=(z.value[t]||[])[0];return a?.id?`/teach-internal/${encodeURIComponent(n)}/course/${encodeURIComponent(t)}/module/${encodeURIComponent(a.id)}/view`:`/teach-internal/${encodeURIComponent(n)}`}function m(e){const t=`?institutionId=${encodeURIComponent(I.value)}`;return e==="overview"?`/institution/portal${t}`:e==="departments"?k.value?`/institution/departments/${encodeURIComponent(k.value)}${t}`:`/institution/portal${t}`:e==="classrooms"?C.value?`/institution/classrooms/${encodeURIComponent(C.value)}${t}`:`/institution/portal${t}`:e==="people"?`/institution/people${t}`:e==="catalog"?`/institution/catalog${t}`:e==="calendar"?`/institution/calendar${t}`:e==="assignments"?`/institution/assignments/teachers${t}`:`/institution/portal${t}`}async function W(){try{const e=T();if(!e)return;const t=p?p.replace(/\/$/,""):"",a=(await(await fetch(`${t}/api/authentication/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query Me { me { id } }"})})).json().catch(()=>null))?.data?.me?.id||null;if(E.value=a,!a){y.value="none";return}const l=await(await fetch(`${t}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query($institutionId:String!){ members(institutionId:$institutionId){ userId role } }",variables:{institutionId:I.value}})})).json().catch(()=>null),d=(Array.isArray(l?.data?.members)?l.data.members:[]).find(A=>A.userId===a),_=String(d?.role||"").toLowerCase();_.includes("admin")?y.value="admin":_.includes("teach")?y.value="teacher":_.includes("student")?y.value="student":y.value="none"}catch{}}return(e,t)=>{const n=c("a-menu-item"),r=c("a-menu"),a=c("a-input"),o=c("a-select"),l=c("a-button"),f=c("a-space"),d=c("a-page-header"),_=c("a-tag"),A=c("a-table"),G=c("a-card"),Q=c("a-skeleton");return g(),x("div",ne,[i(d,{title:"Institution Course Catalog"},{extra:s(()=>[i(f,null,{default:s(()=>[i(r,{mode:"horizontal",selectedKeys:["catalog"]},{default:s(()=>[i(n,{key:"overview"},{default:s(()=>[h("a",{href:m("overview")},"Overview",8,oe)]),_:1}),y.value==="admin"?(g(),U(n,{key:"departments"},{default:s(()=>[h("a",{href:m("departments")},"Departments",8,se)]),_:1})):P("",!0),i(n,{key:"classrooms"},{default:s(()=>[h("a",{href:m("classrooms")},"Classrooms",8,ie)]),_:1}),i(n,{key:"people"},{default:s(()=>[h("a",{href:m("people")},"People Directory",8,re)]),_:1}),i(n,{key:"catalog"},{default:s(()=>[h("a",{href:m("catalog")},"Catalog",8,le)]),_:1}),i(n,{key:"calendar"},{default:s(()=>[h("a",{href:m("calendar")},"Calendar",8,ce)]),_:1}),i(n,{key:"assignments"},{default:s(()=>[h("a",{href:m("assignments")},"Assignments",8,ue)]),_:1})]),_:1}),i(a,{value:w.value,"onUpdate:value":t[0]||(t[0]=v=>w.value=v),placeholder:"Search",style:{width:"220px"}},null,8,["value"]),i(o,{value:b.value,"onUpdate:value":t[1]||(t[1]=v=>b.value=v),placeholder:"Difficulty",style:{width:"160px"},"allow-clear":"",options:M},null,8,["value"]),i(l,{size:"small",onClick:N},{default:s(()=>[...t[2]||(t[2]=[R("Reload",-1)])]),_:1})]),_:1})]),_:1}),i(Q,{loading:$.value,active:"",paragraph:{rows:8}},{default:s(()=>[i(G,{size:"small"},{default:s(()=>[i(A,{size:"small",columns:V,dataSource:L.value,"row-key":"courseId",pagination:{pageSize:8}},{bodyCell:s(({column:v,record:S})=>[v.key==="actions"?(g(),x("a",{key:0,href:K(S)},"Open",8,de)):v.key==="availability"?(g(),x(te,{key:1},[O.value.includes(String(S.teacherId||S.teacher_id||""))?(g(),U(_,{key:0,color:"geekblue"},{default:s(()=>[...t[3]||(t[3]=[R("Institution course",-1)])]),_:1})):(g(),U(_,{key:1,color:"purple"},{default:s(()=>[...t[4]||(t[4]=[R("Global course",-1)])]),_:1}))],64)):P("",!0)]),_:1},8,["dataSource"])]),_:1})]),_:1},8,["loading"])])}}}),he=ae(pe,[["__scopeId","data-v-5d0376b8"]]);export{he as default};
