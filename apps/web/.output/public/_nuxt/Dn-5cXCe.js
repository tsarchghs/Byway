import{g as j,W as T,r as p,k as B,l as J,c as R,b as i,w as s,n as _,p as r,o as v,d as b,q as z,K as N,_ as O}from"./DQDUwbr-.js";const U={class:"join-institution"},P=j({__name:"index",setup(E){const w=T(),d=w.public?.apiBase||w.public?.appBaseUrl||"",m=p(!0),h=p(null),c=p(""),f=p([]);function g(){if(typeof window>"u")return null;const t=localStorage.getItem("token")||localStorage.getItem("access_token")||"";return t?t.startsWith("Bearer")?t:`Bearer ${t}`:null}async function k(){m.value=!0;try{const t=g();if(!t)throw new Error("Missing auth token");const e=d?d.replace(/\/$/,""):"",n=await(await fetch(`${e}/api/authentication/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:t},body:JSON.stringify({query:"query Me { me { id } }"})})).json().catch(()=>null);h.value=n?.data?.me?.id||null;const o=await fetch(`${e}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:t},body:JSON.stringify({query:"query { institutions { id name slug type location active createdAt updatedAt } }"})});if(!o.ok)throw new Error(await o.text().catch(()=>`HTTP ${o.status}`));const l=await o.json();f.value=Array.isArray(l?.data?.institutions)?l.data.institutions:[],h.value&&await x(t,e)}catch(t){_.error(t?.message||"Failed to load institutions")}finally{m.value=!1}}B(k);const I=J(()=>f.value.filter(t=>c.value?String(t.name).toLowerCase().includes(c.value.toLowerCase())||String(t.slug).toLowerCase().includes(c.value.toLowerCase()):!0));async function C(t){try{const e=g();if(!e)throw new Error("Missing auth token");const a=d?d.replace(/\/$/,""):"",n=await fetch(`${a}/api/institution-portal/institutions/${encodeURIComponent(t)}/join`,{method:"POST",headers:{Authorization:e}});if(!n.ok)throw new Error(await n.text().catch(()=>`HTTP ${n.status}`));_.success("Joined institution"),window.location.href=`/institution/portal?institutionId=${encodeURIComponent(t)}`}catch(e){_.error(e?.message||"Join failed")}}const S=[{title:"Name",dataIndex:"name",key:"name"},{title:"Slug",dataIndex:"slug",key:"slug"},{title:"Type",dataIndex:"type",key:"type"},{title:"Location",dataIndex:"location",key:"location"},{title:"Actions",key:"actions"}];async function x(t,e){try{for(const a of f.value){const u=await(await fetch(`${e}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:t},body:JSON.stringify({query:"query($institutionId:String!){ members(institutionId:$institutionId){ userId } }",variables:{institutionId:a.id}})})).json().catch(()=>null);if((Array.isArray(u?.data?.members)?u.data.members:[]).find(l=>l.userId===h.value)){window.location.href=`/institution/portal?institutionId=${encodeURIComponent(a.id)}`;return}}}catch{}}return(t,e)=>{const a=r("a-input"),n=r("a-button"),u=r("a-space"),o=r("a-page-header"),l=r("a-table"),$=r("a-card"),A=r("a-skeleton");return v(),R("div",U,[i(o,{title:"Join Institution"},{extra:s(()=>[i(u,null,{default:s(()=>[i(a,{value:c.value,"onUpdate:value":e[0]||(e[0]=y=>c.value=y),placeholder:"Search institutions",style:{width:"240px"}},null,8,["value"]),i(n,{size:"small",onClick:k},{default:s(()=>[...e[1]||(e[1]=[b("Reload",-1)])]),_:1})]),_:1})]),_:1}),i(A,{loading:m.value,active:"",paragraph:{rows:6}},{default:s(()=>[i($,{size:"small"},{default:s(()=>[i(l,{size:"small",columns:S,dataSource:I.value,"row-key":"id"},{bodyCell:s(({column:y,record:q})=>[y.key==="actions"?(v(),z(n,{key:0,type:"link",onClick:L=>C(q.id)},{default:s(()=>[...e[2]||(e[2]=[b("Join",-1)])]),_:1},8,["onClick"])):N("",!0)]),_:1},8,["dataSource"])]),_:1})]),_:1},8,["loading"])])}}}),H=O(P,[["__scopeId","data-v-a0474eb0"]]);export{H as default};
