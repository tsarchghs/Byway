import{g as Z,U as ee,W as te,l as T,r as u,k as E,ad as ae,c as se,b as a,q as S,w as s,n as I,p as n,o as b,K as M,a as _,d as A,ag as J,_ as oe}from"./DQDUwbr-.js";const ne={class:"teacher-assignments"},re=["href"],le=["href"],ie=["href"],ue=["href"],ce=["href"],de=["href"],pe=["href"],me=Z({__name:"teachers",setup(fe){const U=ee(),O=te(),c=O.public?.apiBase||O.public?.appBaseUrl||"",g=T(()=>U.query.institutionId||U.params?.institution_id||"inst_byway"),x=u(!0),z=u([]),N=u([]),j=u([]),q=u([]),l=u("none"),H=u(null),d=u({}),p=u({});function k(){if(typeof window>"u")return null;const e=localStorage.getItem("token")||localStorage.getItem("access_token")||"";return e?e.startsWith("Bearer")?e:`Bearer ${e}`:null}async function $(){x.value=!0;try{const e=k();if(!e)throw new Error("Missing auth token");const o=`${c?c.replace(/\/$/,""):""}/api/institution-portal/teacher-assignments?institutionId=${encodeURIComponent(g.value)}`,f=await fetch(o,{headers:{Authorization:e}});if(!f.ok)throw new Error(await f.text().catch(()=>`HTTP ${f.status}`));const r=await f.json();z.value=r.teachers||[],N.value=r.classrooms||[],j.value=r.courses||[],q.value=r.assignments||[]}catch(e){I.error(e?.message||"Failed to load")}finally{x.value=!1}}E($);async function V(){try{const e=k();if(!e)return;const t=c?c.replace(/\/$/,""):"",r=(await(await fetch(`${t}/api/authentication/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query Me { me { id } }"})})).json().catch(()=>null))?.data?.me?.id||null;if(H.value=r,!r){l.value="none";return}const C=await(await fetch(`${t}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query($institutionId:String!){ members(institutionId:$institutionId){ userId role } }",variables:{institutionId:g.value}})})).json().catch(()=>null),m=(Array.isArray(C?.data?.members)?C.data.members:[]).find(w=>w.userId===r),v=String(m?.role||"").toLowerCase();v.includes("admin")?l.value="admin":v.includes("teach")?l.value="teacher":v.includes("student")?l.value="student":l.value="none"}catch{}}E(()=>{V()}),ae(l,e=>{e==="student"&&(window.location.href=i("overview"))});const B=T(()=>z.value.map(e=>({label:e.displayName||e.userId,value:e.userId}))),D=T(()=>N.value.map(e=>({label:e.title,value:e.id}))),K=T(()=>j.value.map(e=>({label:e.title,value:e.courseId})));async function W(){try{const e=k();if(!e)throw new Error("Missing auth token");const t=c?c.replace(/\/$/,""):"",o=await fetch(`${t}/api/institution-portal/assignments/teacher`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({scope:"classroom",institutionId:g.value,teacherId:d.value.teacherId,classroomId:d.value.classroomId})});if(!o.ok)throw new Error(await o.text().catch(()=>`HTTP ${o.status}`));I.success("Assigned to classroom"),$()}catch(e){I.error(e?.message||"Assign failed")}}async function F(){try{const e=k();if(!e)throw new Error("Missing auth token");const t=c?c.replace(/\/$/,""):"",o=await fetch(`${t}/api/institution-portal/assignments/teacher`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({scope:"course",institutionId:g.value,teacherId:p.value.teacherId,courseId:p.value.courseId})});if(!o.ok)throw new Error(await o.text().catch(()=>`HTTP ${o.status}`));I.success("Assigned to course"),$()}catch(e){I.error(e?.message||"Assign failed")}}const G=[{title:"Type",dataIndex:"type",key:"type"},{title:"Teacher",dataIndex:"teacher",key:"teacher"},{title:"Target",dataIndex:"target",key:"target"}];function i(e){const t=`?institutionId=${encodeURIComponent(g.value)}`;return e==="overview"?`/institution/portal${t}`:e==="departments"?`/institution/departments/${t}`:e==="classrooms"?`/institution/classrooms/${t}`:e==="people"?`/institution/people${t}`:e==="catalog"?`/institution/catalog${t}`:e==="calendar"?`/institution/calendar${t}`:e==="assignments"?`/institution/assignments/teachers${t}`:`/institution/portal${t}`}return(e,t)=>{const o=n("a-menu-item"),f=n("a-menu"),r=n("a-button"),R=n("a-space"),C=n("a-page-header"),y=n("a-select"),m=n("a-form-item"),v=n("a-form"),w=n("a-card"),P=n("a-col"),L=n("a-row"),Q=n("a-table"),X=n("a-skeleton"),Y=n("a-result");return b(),se("div",ne,[a(C,{title:"Teacher Assignment Manager"},{extra:s(()=>[a(R,null,{default:s(()=>[a(f,{mode:"horizontal",selectedKeys:["assignments"]},{default:s(()=>[a(o,{key:"overview"},{default:s(()=>[_("a",{href:i("overview")},"Overview",8,re)]),_:1}),l.value==="admin"?(b(),S(o,{key:"departments"},{default:s(()=>[_("a",{href:i("departments")},"Departments",8,le)]),_:1})):M("",!0),a(o,{key:"classrooms"},{default:s(()=>[_("a",{href:i("classrooms")},"Classrooms",8,ie)]),_:1}),a(o,{key:"people"},{default:s(()=>[_("a",{href:i("people")},"People Directory",8,ue)]),_:1}),a(o,{key:"catalog"},{default:s(()=>[_("a",{href:i("catalog")},"Catalog",8,ce)]),_:1}),a(o,{key:"calendar"},{default:s(()=>[_("a",{href:i("calendar")},"Calendar",8,de)]),_:1}),l.value!=="student"?(b(),S(o,{key:"assignments"},{default:s(()=>[_("a",{href:i("assignments")},"Assignments",8,pe)]),_:1})):M("",!0)]),_:1}),a(r,{size:"small",onClick:$},{default:s(()=>[...t[6]||(t[6]=[A("Reload",-1)])]),_:1})]),_:1})]),_:1}),l.value!=="student"&&l.value!=="none"?(b(),S(X,{key:0,loading:x.value,active:"",paragraph:{rows:6}},{default:s(()=>[a(L,{gutter:16},{default:s(()=>[a(P,{span:12},{default:s(()=>[a(w,{size:"small",title:"Assign to Classroom"},{default:s(()=>[a(v,{layout:"vertical",onSubmit:t[2]||(t[2]=J(()=>{},["prevent"]))},{default:s(()=>[a(m,{label:"Teacher"},{default:s(()=>[a(y,{value:d.value.teacherId,"onUpdate:value":t[0]||(t[0]=h=>d.value.teacherId=h),options:B.value,placeholder:"Select teacher"},null,8,["value","options"])]),_:1}),a(m,{label:"Classroom"},{default:s(()=>[a(y,{value:d.value.classroomId,"onUpdate:value":t[1]||(t[1]=h=>d.value.classroomId=h),options:D.value,placeholder:"Select classroom"},null,8,["value","options"])]),_:1}),a(m,null,{default:s(()=>[a(r,{type:"primary",onClick:W,disabled:!d.value.teacherId||!d.value.classroomId},{default:s(()=>[...t[7]||(t[7]=[A("Assign",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),a(P,{span:12},{default:s(()=>[a(w,{size:"small",title:"Assign to Course"},{default:s(()=>[a(v,{layout:"vertical",onSubmit:t[5]||(t[5]=J(()=>{},["prevent"]))},{default:s(()=>[a(m,{label:"Teacher"},{default:s(()=>[a(y,{value:p.value.teacherId,"onUpdate:value":t[3]||(t[3]=h=>p.value.teacherId=h),options:B.value,placeholder:"Select teacher"},null,8,["value","options"])]),_:1}),a(m,{label:"Course"},{default:s(()=>[a(y,{value:p.value.courseId,"onUpdate:value":t[4]||(t[4]=h=>p.value.courseId=h),options:K.value,placeholder:"Select course"},null,8,["value","options"])]),_:1}),a(m,null,{default:s(()=>[a(r,{type:"primary",onClick:F,disabled:!p.value.teacherId||!p.value.courseId},{default:s(()=>[...t[8]||(t[8]=[A("Assign",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(w,{size:"small",title:"Current Assignments",style:{"margin-top":"16px"}},{default:s(()=>[a(Q,{size:"small",columns:G,dataSource:q.value,"row-key":"id"},null,8,["dataSource"])]),_:1})]),_:1},8,["loading"])):(b(),S(Y,{key:1,status:"403",title:"Not allowed","sub-title":"This page is for teachers and administrators."},{extra:s(()=>[a(r,{type:"primary",href:i("overview")},{default:s(()=>[...t[9]||(t[9]=[A("Go to portal",-1)])]),_:1},8,["href"])]),_:1}))])}}}),_e=oe(me,[["__scopeId","data-v-0a1e945b"]]);export{_e as default};
