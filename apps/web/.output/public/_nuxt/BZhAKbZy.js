import{g as de,U as ce,r as c,l as b,j as me,k as pe,ad as fe,c as ve,b as n,w as o,I as ge,p as r,m as u,o as N,x as _,a as x,d as i,S as be,bA as _e,bq as we,as as ye,q as A,t as ke,n as v,_ as Se}from"./DQDUwbr-.js";const xe={class:"toolbar flex justify-between mb-3 flex-wrap items-center gap-2"},he={class:"mt-2 flex gap-2 items-center"},Oe={class:"mt-2"},Ce=de({__name:"grading",setup(Ie){const h=ce(),m=c([]),l=c([{label:"Code",weight:.6},{label:"Report",weight:.4}]),w=c(!1),g=c(JSON.stringify(l.value,null,2)),U=b(()=>l.value.reduce((t,e)=>t+(e.weight||0),0)),O=c(!1),d=me({}),F=b(()=>d[C.value]||[]),C=c(""),y=c(""),f=c(!0),B=c("teacher-01"),z=b(()=>`byway.mock.grade.${h.params.id}`),L=[{title:"Attempt",dataIndex:"attempt",key:"attempt",sorter:(t,e)=>t.attempt-e.attempt},{title:"Student",dataIndex:"studentId",key:"studentId"},{title:"File",key:"file",customRender:({record:t})=>u("a",{href:t.fileUrl,target:"_blank"},"Open")}],W=b(()=>l.value.map(t=>({title:`${t.label} (${(t.weight*100).toFixed(0)}%)`,key:`crit-${t.label}`,customRender:({record:e})=>u("a-input-number",{min:0,max:100,value:e.criteria[t.label]??0,"onUpdate:value":a=>{e.criteria[t.label]=a,f.value&&p()}})}))),D={title:"Weighted",key:"weighted",customRender:({record:t})=>{const e=J(t).toFixed(1);return u("div",{},[u("span",{},e),u("a",{style:"margin-left:8px",onClick:()=>T(t)},"Apply")])}},G={title:"Grade",key:"grade",customRender:({record:t})=>u("div",{},[u("a-input-number",{min:0,max:100,value:t._grade??t.grade??0,"onUpdate:value":e=>t._grade=e}),u("a-button",{style:"margin-left:8px",onClick:()=>I(t)},"Save")])},V={title:"Feedback",key:"feedback",customRender:({record:t})=>u("a-input",{style:"min-width:220px",value:t._feedback??t.feedback,"onUpdate:value":e=>t._feedback=e,onBlur:()=>{f.value&&I(t,{silent:!0})}})},q={title:"Comments",key:"comments",customRender:({record:t})=>u("a",{onClick:()=>Q(t.id)},"Open")},P=b(()=>[...L,...W.value,D,G,V,q]);function J(t){return l.value.reduce((e,a)=>e+(t.criteria[a.label]||0)*a.weight,0)}function T(t){t._grade=Math.round(J(t)*10)/10,f.value&&I(t,{silent:!0})}function I(t,e){typeof t._grade=="number"&&(t.grade=t._grade),typeof t._feedback<"u"&&(t.feedback=t._feedback),p(),e?.silent||v.success("Saved")}function K(){g.value=JSON.stringify(l.value,null,2),w.value=!0}function Y(){try{const t=JSON.parse(g.value);if(!Array.isArray(t))throw new Error("Must be an array");t.forEach((e,a)=>{if(typeof e.label!="string"||typeof e.weight!="number")throw new Error(`Invalid item #${a}`)}),l.value=t,m.value.forEach(e=>{for(const a of l.value)typeof e.criteria[a.label]!="number"&&(e.criteria[a.label]=0)}),p(),w.value=!1,v.success("Rubric saved")}catch(t){v.error(t?.message||"Invalid JSON")}}function H(){const t=l.value.reduce((e,a)=>e+(a.weight||0),0)||1;l.value=l.value.map(e=>({...e,weight:+(e.weight/t).toFixed(4)})),g.value=JSON.stringify(l.value,null,2)}function Q(t){C.value=t,d[t]||(d[t]=[]),O.value=!0}function X(){const t=C.value,e=y.value.trim();if(!t||!e)return;const a={id:ne(),text:e,at:new Date().toLocaleString(),authorId:B.value};d[t].unshift(a),y.value="",p()}function p(){const t={rows:m.value,rubric:l.value,comments:d};console.debug("setItem replaced"),z.value,JSON.stringify(t)}function Z(){return!1}async function ee(t){try{const e=await t.text(),a=JSON.parse(e);m.value=a.rows||[],l.value=a.rubric||[],Object.assign(d,a.comments||{}),p(),v.success("Imported")}catch(e){v.error(e?.message||"Import failed")}return!1}function te(){const t=new Blob([JSON.stringify({rows:m.value,rubric:l.value,comments:d},null,2)],{type:"application/json"}),e=URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.download=`grade-${h.params.id}.json`,a.click(),URL.revokeObjectURL(e)}function $(t=10){return Array.from({length:t},(e,a)=>({id:`sub-${a+1}`,attempt:a%2+1,studentId:`student-${String(a+1).padStart(2,"0")}`,fileUrl:"https://example.com/file.pdf",criteria:l.value.reduce((k,S)=>(k[S.label]=Math.round(60+Math.random()*40),k),{}),grade:void 0,feedback:""}))}function ae(){m.value=$(10),Object.keys(d).forEach(t=>delete d[t]),p(),v.success("Mock reset")}function ne(){return Math.random().toString(36).slice(2,9)}return pe(()=>{Z()||(m.value=$(10),p())}),fe([m,l],()=>{f.value&&p()},{deep:!0}),(t,e)=>{const a=r("a-button"),k=r("a-switch"),S=r("a-divider"),oe=r("a-upload"),le=r("a-space"),R=r("a-tag"),se=r("a-table"),re=r("a-card"),ue=r("a-layout"),ie=r("a-alert"),M=r("a-textarea"),E=r("a-list"),j=r("a-drawer");return N(),ve(ge,null,[n(ue,{class:"p-6 grade-page"},{default:o(()=>[n(re,{title:`Grade · ${_(h).params.id}`,bordered:!1},{default:o(()=>[x("div",xe,[n(le,{wrap:""},{default:o(()=>[n(a,{onClick:K},{icon:o(()=>[n(_(be))]),default:o(()=>[e[5]||(e[5]=i(" Rubric ",-1))]),_:1}),n(k,{checked:f.value,"onUpdate:checked":e[0]||(e[0]=s=>f.value=s)},null,8,["checked"]),e[9]||(e[9]=i()),e[10]||(e[10]=x("span",{class:"muted"},"Auto-save",-1)),n(S,{type:"vertical"}),n(a,{onClick:te},{icon:o(()=>[n(_(_e))]),default:o(()=>[e[6]||(e[6]=i(" Export JSON ",-1))]),_:1}),n(oe,{"before-upload":ee,accept:".json"},{default:o(()=>[n(a,null,{icon:o(()=>[n(_(we))]),default:o(()=>[e[7]||(e[7]=i(" Import JSON ",-1))]),_:1})]),_:1}),n(a,{danger:"",onClick:ae},{icon:o(()=>[n(_(ye))]),default:o(()=>[e[8]||(e[8]=i(" Reset ",-1))]),_:1})]),_:1}),n(R,{color:"orange"},{default:o(()=>[...e[11]||(e[11]=[i("Mock mode",-1)])]),_:1})]),n(se,{"data-source":m.value,columns:P.value,"row-key":"id",bordered:"",size:"middle",pagination:{pageSize:8}},null,8,["data-source","columns"])]),_:1},8,["title"])]),_:1}),n(j,{open:w.value,"onUpdate:open":e[2]||(e[2]=s=>w.value=s),title:"Rubric editor",placement:"right",width:"440"},{default:o(()=>[n(ie,{type:"info","show-icon":"",message:"Provide JSON rubric — e.g. [{label:'Code',weight:0.6},{label:'Report',weight:0.4}]",class:"mb-2"}),n(M,{value:g.value,"onUpdate:value":e[1]||(e[1]=s=>g.value=s),rows:10},null,8,["value"]),x("div",he,[n(a,{type:"primary",onClick:Y},{default:o(()=>[...e[12]||(e[12]=[i("Save",-1)])]),_:1}),n(a,{onClick:H},{default:o(()=>[...e[13]||(e[13]=[i("Normalize weights",-1)])]),_:1}),Math.abs(U.value-1)<1e-6?(N(),A(R,{key:0,color:"green"},{default:o(()=>[...e[14]||(e[14]=[i("Sum: 1.00",-1)])]),_:1})):(N(),A(R,{key:1,color:"red"},{default:o(()=>[i("Sum: "+ke(U.value.toFixed(2)),1)]),_:1}))]),n(S),n(E,{size:"small","data-source":l.value,renderItem:s=>u("div",{},`${s.label} · ${s.weight}`)},null,8,["data-source","renderItem"])]),_:1},8,["open"]),n(j,{open:O.value,"onUpdate:open":e[4]||(e[4]=s=>O.value=s),title:"Comments",placement:"right",width:"420"},{default:o(()=>[n(E,{"data-source":F.value,renderItem:s=>u("div",{class:"comment-item"},`${s.at} – ${s.authorId||"anon"}: ${s.text}`)},null,8,["data-source","renderItem"]),n(M,{value:y.value,"onUpdate:value":e[3]||(e[3]=s=>y.value=s),rows:3,class:"mt-2",placeholder:"Add a comment..."},null,8,["value"]),x("div",Oe,[n(a,{type:"primary",onClick:X},{default:o(()=>[...e[15]||(e[15]=[i("Post",-1)])]),_:1})])]),_:1},8,["open"])],64)}}}),Ne=Se(Ce,[["__scopeId","data-v-f8f7005f"]]);export{Ne as default};
