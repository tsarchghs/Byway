import{g as Q,U as X,W as Y,l as g,r as m,k as B,c as N,b as a,q as A,w as n,n as Z,p as r,o as y,K as T,a as p,d as E,t as ee,_ as te}from"./DQDUwbr-.js";const ae={class:"student-record"},ne=["href"],se=["href"],oe=["href"],re=["href"],ie=["href"],le=["href"],ue=["href"],ce=["href"],de=Q({__name:"[studentId]",setup(me){const w=X(),R=Y(),_=R.public?.apiBase||R.public?.appBaseUrl||"",I=g(()=>String(w.params.studentId||w.params.id||"")),k=g(()=>w.query.institutionId||w.params?.institution_id||"inst_byway"),$=m(!0),f=m([]),z=m([]),U=m(null),i=m("none"),S=m(null),P=m(new Set);function x(){if(typeof window>"u")return null;const e=localStorage.getItem("token")||localStorage.getItem("access_token")||"";return e?e.startsWith("Bearer")?e:`Bearer ${e}`:null}async function j(){$.value=!0;try{const e=x();if(!e)throw new Error("Missing auth token");const s=`${_?_.replace(/\/$/,""):""}/api/institution-portal/students/${encodeURIComponent(I.value)}/record?institutionId=${encodeURIComponent(k.value)}`,l=await fetch(s,{headers:{Authorization:e}});if(!l.ok)throw new Error(await l.text().catch(()=>`HTTP ${l.status}`));const o=await l.json();f.value=o.courses||[],z.value=o.gradebook||[],U.value=o.student||null}catch(e){Z.error(e?.message||"Failed to load record")}finally{$.value=!1}}B(j);async function O(){try{const e=x();if(!e)return;const t=_?_.replace(/\/$/,""):"",o=(await(await fetch(`${t}/api/authentication/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query Me { me { id } }"})})).json().catch(()=>null))?.data?.me?.id||null;if(S.value=o,!o){i.value="none";return}const d=await(await fetch(`${t}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query($institutionId:String!){ members(institutionId:$institutionId){ userId role } }",variables:{institutionId:k.value}})})).json().catch(()=>null),c=(Array.isArray(d?.data?.members)?d.data.members:[]).find(C=>C.userId===o),h=String(c?.role||"").toLowerCase();h.includes("admin")?i.value="admin":h.includes("teach")?i.value="teacher":h.includes("student")?i.value="student":i.value="none",i.value==="teacher"&&await V()}catch{}}async function V(){try{const e=x();if(!e)return;const t=_?_.replace(/\/$/,""):"",l=await(await fetch(`${t}/api/institution-portal/teacher-dashboard?institutionId=${encodeURIComponent(k.value)}`,{headers:{Authorization:e}})).json().catch(()=>null),o=Array.isArray(l?.classrooms)?l.classrooms:[],v=new Set;o.forEach(d=>{(Array.isArray(d?.enrollments)?d.enrollments:[]).forEach(c=>{c?.studentId&&v.add(String(c.studentId))})}),P.value=v}catch{}}B(()=>{O()});const J=g(()=>U.value?.displayName||"Student"),M=g(()=>{if(!f.value.length)return 0;const e=f.value.reduce((t,s)=>t+(s.progressPct||0),0);return Math.round(e/f.value.length)}),D=g(()=>i.value==="admin"?!0:i.value==="teacher"?P.value.has(String(I.value)):i.value==="student"?!!S.value&&I.value===S.value:!1),H=[{title:"Course",dataIndex:"title",key:"title"},{title:"Progress",dataIndex:"progressPct",key:"progressPct"},{title:"Completed",dataIndex:"completed",key:"completed"}],F=[{title:"Course",dataIndex:"courseTitle",key:"courseTitle"},{title:"Score",dataIndex:"grade",key:"grade"},{title:"Feedback",dataIndex:"feedback",key:"feedback"}];function u(e){const t=`?institutionId=${encodeURIComponent(k.value)}`;return e==="overview"?`/institution/portal${t}`:e==="departments"?`/institution/departments/${t}`:e==="classrooms"?`/institution/classrooms/${t}`:e==="people"?`/institution/people${t}`:e==="catalog"?`/institution/catalog${t}`:e==="calendar"?`/institution/calendar${t}`:e==="assignments"?`/institution/assignments/teachers${t}`:`/institution/portal${t}`}return(e,t)=>{const s=r("a-menu-item"),l=r("a-menu"),o=r("a-button"),v=r("a-space"),d=r("a-page-header"),b=r("a-table"),c=r("a-card"),h=r("a-col"),C=r("a-statistic"),G=r("a-row"),K=r("a-skeleton"),W=r("a-result");return y(),N("div",ae,[a(d,{title:J.value,"sub-title":I.value},{extra:n(()=>[a(v,null,{default:n(()=>[a(l,{mode:"horizontal",selectedKeys:["people"]},{default:n(()=>[a(s,{key:"overview"},{default:n(()=>[p("a",{href:u("overview")},"Overview",8,ne)]),_:1}),i.value==="admin"?(y(),A(s,{key:"departments"},{default:n(()=>[p("a",{href:u("departments")},"Departments",8,se)]),_:1})):T("",!0),a(s,{key:"classrooms"},{default:n(()=>[p("a",{href:u("classrooms")},"Classrooms",8,oe)]),_:1}),a(s,{key:"people"},{default:n(()=>[p("a",{href:u("people")},"People Directory",8,re)]),_:1}),a(s,{key:"catalog"},{default:n(()=>[p("a",{href:u("catalog")},"Catalog",8,ie)]),_:1}),a(s,{key:"calendar"},{default:n(()=>[p("a",{href:u("calendar")},"Calendar",8,le)]),_:1}),a(s,{key:"assignments"},{default:n(()=>[p("a",{href:u("assignments")},"Assignments",8,ue)]),_:1})]),_:1}),a(o,{size:"small",onClick:j},{default:n(()=>[...t[0]||(t[0]=[E("Reload",-1)])]),_:1})]),_:1})]),_:1},8,["title","sub-title"]),D.value?(y(),A(K,{key:0,loading:$.value,active:"",paragraph:{rows:8}},{default:n(()=>[a(G,{gutter:16},{default:n(()=>[a(h,{span:16},{default:n(()=>[a(c,{size:"small",title:"Courses"},{default:n(()=>[a(b,{size:"small",columns:H,dataSource:f.value,"row-key":"courseId"},{bodyCell:n(({column:L,record:q})=>[L.dataIndex==="title"?(y(),N("a",{key:0,href:`/teach-internal/${encodeURIComponent(q.teacherId||"teacher")}`},ee(q.title),9,ce)):T("",!0)]),_:1},8,["dataSource"])]),_:1}),a(c,{size:"small",title:"Gradebook",style:{"margin-top":"16px"}},{default:n(()=>[a(b,{size:"small",columns:F,dataSource:z.value,"row-key":"id"},null,8,["dataSource"])]),_:1})]),_:1}),a(h,{span:8},{default:n(()=>[a(c,{size:"small",title:"Summary"},{default:n(()=>[a(C,{title:"Courses",value:f.value.length},null,8,["value"]),a(C,{title:"Average Progress",value:M.value,suffix:"%",style:{"margin-top":"8px"}},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1},8,["loading"])):(y(),A(W,{key:1,status:"403",title:"Not allowed","sub-title":"Access restricted to admin and assigned teachers; students may view only their own record."},{extra:n(()=>[a(o,{type:"primary",href:u("overview")},{default:n(()=>[...t[1]||(t[1]=[E("Go to portal",-1)])]),_:1},8,["href"])]),_:1}))])}}}),_e=te(de,[["__scopeId","data-v-a284c2ca"]]);export{_e as default};
