import{g as P,U as J,W as V,l as j,r as f,k as F,c as q,b as a,w as n,n as H,p as l,o as k,q as M,K as B,a as d,d as K,t as W,_ as L}from"./DQDUwbr-.js";const G={class:"people-directory"},Q=["href"],X=["href"],Y=["href"],Z=["href"],ee=["href"],te=["href"],ae=["href"],ne=["href"],oe=P({__name:"index",setup(se){const C=J(),S=V(),p=S.public?.apiBase||S.public?.appBaseUrl||"",h=j(()=>C.query.institutionId||C.params?.institution_id||"inst_byway"),I=f(!0),x=f([]),y=f(void 0),r=f("none"),z=f(null),A=f(new Set);function g(){if(typeof window>"u")return null;const e=localStorage.getItem("token")||localStorage.getItem("access_token")||"";return e?e.startsWith("Bearer")?e:`Bearer ${e}`:null}async function R(){I.value=!0;try{const e=g();if(!e)throw new Error("Missing auth token");const o=`${p?p.replace(/\/$/,""):""}/api/institution-portal/people?institutionId=${encodeURIComponent(h.value)}`,s=await fetch(o,{headers:{Authorization:e}});if(!s.ok)throw new Error(await s.text().catch(()=>`HTTP ${s.status}`));const i=await s.json();x.value=i.members||[]}catch(e){H.error(e?.message||"Failed to load directory")}finally{I.value=!1}}async function T(){try{const e=g();if(!e)return;const t=p?p.replace(/\/$/,""):"",i=(await(await fetch(`${t}/api/authentication/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query Me { me { id } }"})})).json().catch(()=>null))?.data?.me?.id||null;if(z.value=i,!i){r.value="none";return}const c=await(await fetch(`${t}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query($institutionId:String!){ members(institutionId:$institutionId){ userId role } }",variables:{institutionId:h.value}})})).json().catch(()=>null),m=(Array.isArray(c?.data?.members)?c.data.members:[]).find(b=>b.userId===i),v=String(m?.role||"").toLowerCase();v.includes("admin")?r.value="admin":v.includes("teach")?r.value="teacher":v.includes("student")?r.value="student":r.value="none",r.value==="teacher"&&await E()}catch{}}F(async()=>{await R(),await T()});const N=j(()=>{let e=x.value;return r.value==="student"?e=e.filter(t=>t.role==="student"):r.value==="teacher"&&(e=e.filter(t=>t.role==="student"&&A.value.has(String(t.userId)))),e.filter(t=>y.value?t.role===y.value:!0)}),O=[{label:"Student",value:"student"},{label:"Teacher",value:"teacher"},{label:"Admin",value:"admin"}],D=[{title:"User ID",dataIndex:"userId",key:"userId"},{title:"Role",dataIndex:"role",key:"role"},{title:"Status",dataIndex:"status",key:"status"},{title:"Classrooms",dataIndex:"classroomCount",key:"classroomCount"}];function u(e){const t=`?institutionId=${encodeURIComponent(h.value)}`;return e==="overview"?`/institution/portal${t}`:e==="departments"?`/institution/departments/${t}`:e==="classrooms"?`/institution/classrooms/${t}`:e==="people"?`/institution/people${t}`:e==="catalog"?`/institution/catalog${t}`:e==="calendar"?`/institution/calendar${t}`:e==="assignments"?`/institution/assignments/teachers${t}`:`/institution/portal${t}`}async function E(){try{const e=g();if(!e)return;const t=p?p.replace(/\/$/,""):"",s=await(await fetch(`${t}/api/institution-portal/teacher-dashboard?institutionId=${encodeURIComponent(h.value)}`,{headers:{Authorization:e}})).json().catch(()=>null),i=Array.isArray(s?.classrooms)?s.classrooms:[],_=new Set;i.forEach(c=>{(Array.isArray(c?.enrollments)?c.enrollments:[]).forEach(m=>{m?.studentId&&_.add(String(m.studentId))})}),A.value=_}catch{}}return(e,t)=>{const o=l("a-menu-item"),s=l("a-menu"),i=l("a-select"),_=l("a-button"),c=l("a-space"),w=l("a-page-header"),m=l("a-table"),v=l("a-card"),b=l("a-skeleton");return k(),q("div",G,[a(w,{title:"Institution People Directory"},{extra:n(()=>[a(c,null,{default:n(()=>[a(s,{mode:"horizontal",selectedKeys:["people"]},{default:n(()=>[a(o,{key:"overview"},{default:n(()=>[d("a",{href:u("overview")},"Overview",8,Q)]),_:1}),r.value==="admin"?(k(),M(o,{key:"departments"},{default:n(()=>[d("a",{href:u("departments")},"Departments",8,X)]),_:1})):B("",!0),a(o,{key:"classrooms"},{default:n(()=>[d("a",{href:u("classrooms")},"Classrooms",8,Y)]),_:1}),a(o,{key:"people"},{default:n(()=>[d("a",{href:u("people")},"People Directory",8,Z)]),_:1}),a(o,{key:"catalog"},{default:n(()=>[d("a",{href:u("catalog")},"Catalog",8,ee)]),_:1}),a(o,{key:"calendar"},{default:n(()=>[d("a",{href:u("calendar")},"Calendar",8,te)]),_:1}),a(o,{key:"assignments"},{default:n(()=>[d("a",{href:u("assignments")},"Assignments",8,ae)]),_:1})]),_:1}),a(i,{value:y.value,"onUpdate:value":t[0]||(t[0]=$=>y.value=$),options:O,"allow-clear":"",placeholder:"Filter by role",style:{width:"180px"}},null,8,["value"]),a(_,{size:"small",onClick:R},{default:n(()=>[...t[1]||(t[1]=[K("Reload",-1)])]),_:1})]),_:1})]),_:1}),a(b,{loading:I.value,active:"",paragraph:{rows:8}},{default:n(()=>[a(v,{size:"small"},{default:n(()=>[a(m,{size:"small",columns:D,dataSource:N.value,"row-key":"id"},{bodyCell:n(({column:$,record:U})=>[$.dataIndex==="userId"?(k(),q("a",{key:0,href:`/institution/students/${U.userId}?institutionId=${encodeURIComponent(h.value)}`},W(U.userId),9,ne)):B("",!0)]),_:1},8,["dataSource"])]),_:1})]),_:1},8,["loading"])])}}}),ie=L(oe,[["__scopeId","data-v-fe4342e2"]]);export{ie as default};
