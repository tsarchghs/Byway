import{g as E,U as H,W as K,l as R,r as p,k as T,c as G,b as a,w as t,n as W,p as s,o as d,q as f,K as O,a as m,d as h,t as v,_ as F}from"./DQDUwbr-.js";const L={class:"attendance-view"},Q=["href"],X=["href"],Y=["href"],Z=["href"],ee=["href"],te=["href"],ae=["href"],ne=["href"],se=E({__name:"attendance",setup(oe){const y=H(),x=K(),g=x.public?.apiBase||x.public?.appBaseUrl||"",A=R(()=>String(y.params.classroomId||y.params.id||"")),I=R(()=>y.query.institutionId||y.params?.institution_id||"inst_byway"),k=p(!0),$=p(null),S=p([]),l=p("none"),q=p(null);function z(){if(typeof window>"u")return null;const e=localStorage.getItem("token")||localStorage.getItem("access_token")||"";return e?e.startsWith("Bearer")?e:`Bearer ${e}`:null}async function B(){k.value=!0;try{const e=z();if(!e)throw new Error("Missing auth token");const o=`${g?g.replace(/\/$/,""):""}/api/institution-portal/classrooms/${encodeURIComponent(A.value)}/attendance?institutionId=${encodeURIComponent(I.value)}`,c=await fetch(o,{headers:{Authorization:e}});if(!c.ok)throw new Error(await c.text().catch(()=>`HTTP ${c.status}`));const i=await c.json();$.value=i.classroom||null,S.value=i.roster||[]}catch(e){W.error(e?.message||"Failed to load attendance")}finally{k.value=!1}}T(B),T(M);const J=[{title:"Student",dataIndex:"studentId",key:"studentId"},{title:"Status",dataIndex:"status",key:"status"},{title:"Assignments Submitted",dataIndex:"submissions",key:"submissions"},{title:"Avg Grade",dataIndex:"avgGrade",key:"avgGrade"}],_=R(()=>S.value.find(e=>e.studentId===q.value)||null);function u(e){const n=`?institutionId=${encodeURIComponent(I.value)}`;return e==="overview"?`/institution/portal${n}`:e==="departments"?`/institution/departments/${n}`:e==="classrooms"?`/institution/classrooms/${n}`:e==="people"?`/institution/people${n}`:e==="catalog"?`/institution/catalog${n}`:e==="calendar"?`/institution/calendar${n}`:e==="assignments"?`/institution/assignments/teachers${n}`:`/institution/portal${n}`}async function M(){try{const e=z();if(!e)return;const n=g?g.replace(/\/$/,""):"",i=(await(await fetch(`${n}/api/authentication/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query Me { me { id } }"})})).json().catch(()=>null))?.data?.me?.id||null;if(q.value=i,!i){l.value="none";return}const b=await(await fetch(`${n}/api/institutions/graphql`,{method:"POST",headers:{"content-type":"application/json",Authorization:e},body:JSON.stringify({query:"query($institutionId:String!){ members(institutionId:$institutionId){ userId role } }",variables:{institutionId:I.value}})})).json().catch(()=>null),w=(Array.isArray(b?.data?.members)?b.data.members:[]).find(C=>C.userId===i),r=String(w?.role||"").toLowerCase();r.includes("admin")?l.value="admin":r.includes("teach")?l.value="teacher":r.includes("student")?l.value="student":l.value="none"}catch{}}return(e,n)=>{const o=s("a-menu-item"),c=s("a-menu"),i=s("a-button"),U=s("a-space"),b=s("a-page-header"),j=s("a-table"),w=s("a-card"),r=s("a-descriptions-item"),C=s("a-descriptions"),P=s("a-empty"),V=s("a-skeleton");return d(),G("div",L,[a(b,{title:$.value?.title||$.value?.code||"Classroom Attendance","sub-title":A.value},{extra:t(()=>[a(U,null,{default:t(()=>[a(c,{mode:"horizontal",selectedKeys:["classrooms"]},{default:t(()=>[a(o,{key:"overview"},{default:t(()=>[m("a",{href:u("overview")},"Overview",8,Q)]),_:1}),l.value==="admin"?(d(),f(o,{key:"departments"},{default:t(()=>[m("a",{href:u("departments")},"Departments",8,X)]),_:1})):O("",!0),a(o,{key:"classrooms"},{default:t(()=>[m("a",{href:u("classrooms")},"Classrooms",8,Y)]),_:1}),a(o,{key:"people"},{default:t(()=>[m("a",{href:u("people")},"People Directory",8,Z)]),_:1}),a(o,{key:"catalog"},{default:t(()=>[m("a",{href:u("catalog")},"Catalog",8,ee)]),_:1}),a(o,{key:"calendar"},{default:t(()=>[m("a",{href:u("calendar")},"Calendar",8,te)]),_:1}),a(o,{key:"assignments"},{default:t(()=>[m("a",{href:u("assignments")},"Assignments",8,ae)]),_:1})]),_:1}),a(i,{size:"small",onClick:B},{default:t(()=>[...n[0]||(n[0]=[h("Reload",-1)])]),_:1})]),_:1})]),_:1},8,["title","sub-title"]),a(V,{loading:k.value,active:"",paragraph:{rows:8}},{default:t(()=>[l.value!=="student"?(d(),f(w,{key:0,size:"small",title:"Roster"},{default:t(()=>[a(j,{size:"small",columns:J,dataSource:S.value,"row-key":"studentId"},{bodyCell:t(({column:D,record:N})=>[D.dataIndex==="studentId"?(d(),G("a",{key:0,href:`/institution/students/${N.studentId}?institutionId=${encodeURIComponent(I.value)}`},v(N.studentId),9,ne)):O("",!0)]),_:1},8,["dataSource"])]),_:1})):(d(),f(w,{key:1,size:"small",title:"My Attendance Summary"},{default:t(()=>[_.value?(d(),f(C,{key:0,column:1,size:"small"},{default:t(()=>[a(r,{label:"Student"},{default:t(()=>[h(v(_.value.studentId),1)]),_:1}),a(r,{label:"Status"},{default:t(()=>[h(v(_.value.status),1)]),_:1}),a(r,{label:"Submissions"},{default:t(()=>[h(v(_.value.submissions),1)]),_:1}),a(r,{label:"Avg Grade"},{default:t(()=>[h(v(_.value.avgGrade),1)]),_:1})]),_:1})):(d(),f(P,{key:1,description:"No attendance records for you in this classroom"}))]),_:1}))]),_:1},8,["loading"])])}}}),re=F(se,[["__scopeId","data-v-72414f94"]]);export{re as default};
