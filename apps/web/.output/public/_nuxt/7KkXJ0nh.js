import{u as T}from"./CLh6bXrM.js";import{u as U}from"./CI-SnmTa.js";import{g as x,r as l,U as P,ar as W,W as A,l as I,k as V,c as z,a as $,b as f,t as S,w as m,n as L,p as w,o as M,d as v,x as b,_ as D}from"./DQDUwbr-.js";const E={class:"checkout-success"},F={class:"subtitle"},G=x({__name:"success",setup(K){const s=l("checking"),_=P(),y=W(),{clearCart:q}=T(),{token:g,user:o}=U(),a=l(null),h=l(!1),p=l(null),r=A().public?.apiBase||"http://localhost:4000",R=I(()=>s.value==="ok"?"Payment successful ðŸŽ‰":s.value==="failed"?"We could not confirm your payment":"Finalizing your enrollmentâ€¦"),J=I(()=>s.value==="ok"?"You have access to your course. Keep learning!":s.value==="failed"?"If you were charged, refresh in a moment or contact support.":"We are verifying your payment and enrolling you now.");async function O(t){if(!t){s.value="failed";return}try{const u=await(await fetch(`${r}/api/ecommerce/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query ($s: String!) { verifyCheckout(sessionId: $s) { ok orderId status } }",variables:{s:t}})})).json(),i=u?.data?.verifyCheckout?.ok;if(p.value=u?.data?.verifyCheckout?.orderId||null,s.value=i?"ok":"failed",i){try{await q()}catch{}await N()}}catch(e){s.value="failed",L.warning(e?.message||"Unable to verify checkout. We will keep trying.")}}async function N(){if(!(!g.value||!o.value?.id||!p.value))try{const t={"Content-Type":"application/json",Authorization:`Bearer ${g.value}`};let e=null;const n=o.value?.userId||o.value.id;try{e=(await(await fetch(`${r}/api/students-internal/graphql`,{method:"POST",headers:t,body:JSON.stringify({query:"query($uid:String!){ studentByUserId(userId:$uid){ id } }",variables:{uid:n}})})).json())?.data?.studentByUserId?.id||null}catch{}if(e||(e=(await(await fetch(`${r}/api/students-internal/graphql`,{method:"POST",headers:t,body:JSON.stringify({query:"mutation($uid:String!,$name:String){ createStudent(userId:$uid, displayName:$name){ id } }",variables:{uid:n,name:o.value.email||o.value.displayName||"Student"}})})).json())?.data?.createStudent?.id||null),!e)return;const C=(await(await fetch(`${r}/api/ecommerce/graphql`,{method:"POST",headers:t,body:JSON.stringify({query:"query { myOrders { id items { courseId } } }"})})).json())?.data?.myOrders||[],c=(C.find(d=>d.id===p.value)||C[0])?.items?.[0]?.courseId;if(!c)return;const k=((await(await fetch(`${r}/api/students-internal/graphql`,{method:"POST",headers:t,body:JSON.stringify({query:"query($sid:String!){ myCourses(studentId:$sid){ courseId course { id modules { id title } } } }",variables:{sid:e}})})).json())?.data?.myCourses||[]).find(d=>d.courseId===c)?.course?.modules?.[0]?.id;k?a.value=`/student/${encodeURIComponent(e)}/course/${encodeURIComponent(c)}/module/${encodeURIComponent(k)}`:a.value=`/course/${encodeURIComponent(c)}`}catch{}}function B(){a.value&&(h.value=!0,y.push(a.value))}return V(()=>{const t=_.query.session_id;O(t)}),(t,e)=>{const n=w("a-button"),u=w("a-space");return M(),z("div",E,[$("h2",null,S(R.value),1),$("p",F,S(J.value),1),f(u,null,{default:m(()=>[f(n,{type:"primary",loading:h.value,disabled:!a.value,onClick:B},{default:m(()=>[...e[2]||(e[2]=[v(" Start learning ",-1)])]),_:1},8,["loading","disabled"]),f(n,{onClick:e[0]||(e[0]=i=>b(y).push("/students/my-courses"))},{default:m(()=>[...e[3]||(e[3]=[v("Go to My Courses",-1)])]),_:1}),f(n,{onClick:e[1]||(e[1]=i=>b(y).push("/categories"))},{default:m(()=>[...e[4]||(e[4]=[v("Browse courses",-1)])]),_:1})]),_:1})])}}}),ne=D(G,[["__scopeId","data-v-e78ec752"]]);export{ne as default};
